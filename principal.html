<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Arbitrax</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&display=swap">
  <style>
    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background-image: url('kanchanara-fsSGgTBoX9Y-unsplash.jpg.jpeg');
      background-size: cover;
      background-position: center;
      color: #ffffff;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background-color: rgba(0, 0, 0, 0.6);
      padding: 20px;
    }
    .card {
      background-color: #1c1c1c;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      max-width: 400px;
      width: 100%;
      text-align: center;
      margin: 10px 0;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 10px;
      border: none;
    }
    button {
      padding: 10px 20px;
      border: none;
      background-color: #ff9900;
      color: white;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
    }
    button:hover {
      background-color: #e68a00;
    }
    h2 {
      color: #ff9900;
    }
    .menu {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 20px;
    }
    .menu button {
      margin: 5px;
    }
    .hidden {
      display: none;
    }
    .highlight {
      background-color: #333;
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 20px;
      color: #ffcc00;
      font-weight: bold;
    }
    .referido-box {
      background-color: #333;
      padding: 15px;
      border-radius: 10px;
      margin-top: 10px;
    }
    .nivel-box {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .nivel-card {
      background-color: #2a2a2a;
      padding: 20px;
      border-radius: 15px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .nivel-card:hover {
      transform: scale(1.05);
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: #1c1c1c;
      padding: 30px;
      border-radius: 15px;
      max-width: 400px;
      text-align: center;
    }
    .close-btn {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="login-card" class="card">
      <h2>Iniciar Sesión</h2>
      <input type="email" id="login-email" placeholder="Correo electrónico" required />
      <input type="password" id="login-password" placeholder="Contraseña" required />
      <button onclick="login()">Ingresar</button>
      <p style="margin-top: 10px;">¿No tienes cuenta? <a href="#" onclick="mostrarRegistro()">Registrarse</a></p>
    </div>

    <div id="register-card" class="card hidden">
      <h2>Registro</h2>
      <input type="email" id="register-email" placeholder="Correo electrónico" required />
      <input type="password" id="register-password" placeholder="Contraseña" required />
      <input type="password" id="repeat-password" placeholder="Repetir contraseña" required />
      <button onclick="register()">Registrarse</button>
      <p style="margin-top: 10px;">¿Ya tienes cuenta? <a href="#" onclick="mostrarLogin()">Iniciar sesión</a></p>
    </div>

    <div id="main-menu" class="card hidden">
      <h2>Bienvenido</h2>
      <div class="menu">
        <button onclick="mostrarSeccion('perfil')">Perfil</button>
        <button onclick="mostrarSeccion('nivel')">Nivel de inversión</button>
        <button onclick="mostrarSeccion('deposito')">Depósito</button>
        <button onclick="mostrarSeccion('retiro')">Retiro</button>
        <button onclick="mostrarSeccion('referidos')">Programa de referidos</button>
        <button onclick="cerrarSesion()">Cerrar sesión</button>
      </div>
    </div>

    <div id="perfil" class="card hidden">
      <h2>Perfil</h2>
      <input type="text" id="nombres" placeholder="Nombres" />
      <input type="text" id="apellido" placeholder="Apellido" />
      <input type="text" id="dni" placeholder="DNI" />
      <input type="text" id="celular" placeholder="Celular" />
      <input type="email" id="email" placeholder="Email" disabled />
      <select id="tipo-cuenta" onchange="mostrarCuenta()">
        <option value="">Seleccione tipo de cuenta</option>
        <option value="CBU">CBU</option>
        <option value="USDT">USDT (BEP20)</option>
      </select>
      <input type="text" id="cbu" placeholder="CBU o Dirección USDT" />
      <button onclick="guardarPerfil()">Guardar</button>
      <button onclick="volverMenu()">Volver</button>
    </div>

    <div id="nivel" class="card hidden">
      <h2>Selecciona tu nivel de inversión</h2>
      <div class="highlight">OBTÉN ENTRE UN 60% HASTA 180% DE TU INVERSIÓN</div>
      <div class="nivel-box">
        <div class="nivel-card" onclick="seleccionarNivel('Básico')">
          <strong>Básico</strong><br/>20.000 ARS o 17 USDT
        </div>
        <div class="nivel-card" onclick="seleccionarNivel('Medio')">
          <strong>Medio</strong><br/>100.000 ARS o 90 USDT
        </div>
        <div class="nivel-card" onclick="seleccionarNivel('Avanzado')">
          <strong>Avanzado</strong><br/>500.000 ARS o 420 USDT
        </div>
        <div class="nivel-card" onclick="seleccionarNivel('Avanzado Pro')">
          <strong>Avanzado Pro</strong><br/>1.000.000 ARS o 840 USDT
        </div>
      </div>
      <button onclick="volverMenu()" style="margin-top: 20px;">Volver</button>
    </div>
<div id="deposito" class="card hidden">
      <h2>Depósito</h2>
      <p>Elige el método y completa los datos para realizar tu depósito.</p>
      <select id="metodo-deposito">
        <option value="">Seleccione método</option>
        <option value="ARS">ARS</option>
        <option value="USDT">USDT (BEP20)</option>
      </select>
      <input type="number" id="monto-deposito" placeholder="Monto a depositar" />
      <input type="text" id="detalle-deposito" placeholder="Detalle (CBU o dirección USDT)" />
      <button onclick="guardarDeposito()">Confirmar depósito</button>
      <button onclick="volverMenu()">Volver</button>
    </div>

    <div id="retiro" class="card hidden">
      <h2>Retiro</h2>
      <input type="text" id="retiro-nombres" placeholder="Nombres" />
      <input type="text" id="retiro-apellido" placeholder="Apellido" />
      <input type="text" id="retiro-dni" placeholder="DNI" />
      <select id="tipo-retiro" onchange="mostrarCampoRetiro()">
        <option value="">Tipo de retiro</option>
        <option value="ARS">ARS (CBU)</option>
        <option value="USDT">USDT (BEP20)</option>
      </select>
      <input type="number" id="monto-retiro" placeholder="Monto a retirar" />
      <input type="text" id="campo-cbu-usdt" placeholder="CBU o dirección USDT" />
      <button onclick="guardarRetiro()">Solicitar retiro</button>
      <button onclick="volverMenu()">Volver</button>
    </div>

    <div id="referidos" class="card hidden">
      <h2>Programa de Referidos</h2>
      <p>Tu enlace único para invitar:</p>
      <input type="text" id="link-referido" readonly />
      <button onclick="copiarLink()">Copiar enlace</button>
      <h3>Referidos registrados: <span id="cantidad-referidos">0</span></h3>
      <div class="referido-box">
        <p>Metas de recompensas:</p>
        <ul>
          <li>5 referidos - Recompensa 1</li>
          <li>10 referidos - Recompensa 2</li>
          <li>20 referidos - Recompensa 3</li>
          <li>50 referidos - Recompensa 4</li>
        </ul>
      </div>
      <button onclick="volverMenu()">Volver</button>
    </div>
  </div>

  <script>
    const supabase = supabase.createClient(
      'https://ovulezkcxwrjvyxlxsdv.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92dWxlemtjeHdyanZ5eGx4c2R2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNzY5OTksImV4cCI6MjA2NDY1Mjk5OX0.ac82tkUR7AT0QVsuzuAGA8SXLkgnM9OX62meYNGnToI'
    );

    let currentUser = null;
    let selectedNivel = '';

    async function login() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        alert('Error al iniciar sesión: ' + error.message);
        return;
      }
      currentUser = data.user;
      cargarDatosUsuario();
      mostrarMenuPrincipal();
    }

    async function register() {
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      const repeatPassword = document.getElementById('repeat-password').value;

      if (password !== repeatPassword) {
        alert('Las contraseñas no coinciden');
        return;
      }

      const { data, error } = await supabase.auth.signUp({ email, password });
      if (error) {
        alert('Error al registrarse: ' + error.message);
        return;
      }
      alert('Registro exitoso, revisa tu correo para confirmar');
      mostrarLogin();
    }

    function mostrarRegistro() {
      document.getElementById('login-card').classList.add('hidden');
      document.getElementById('register-card').classList.remove('hidden');
    }

    function mostrarLogin() {
      document.getElementById('register-card').classList.add('hidden');
      document.getElementById('login-card').classList.remove('hidden');
    }

    function mostrarMenuPrincipal() {
      document.getElementById('login-card').classList.add('hidden');
      document.getElementById('register-card').classList.add('hidden');
      document.getElementById('main-menu').classList.remove('hidden');
      cargarLinkReferido();
      cargarCantidadReferidos();
    }

    function mostrarSeccion(id) {
      const secciones = ['perfil', 'nivel', 'deposito', 'retiro', 'referidos'];
      secciones.forEach(sec => {
        document.getElementById(sec).classList.add('hidden');
      });
      if (id === 'nivel') {
        // Reset selection on showing level
        selectedNivel = '';
      }
      document.getElementById(id).classList.remove('hidden');
    }

    function volverMenu() {
      const secciones = ['perfil', 'nivel', 'deposito', 'retiro', 'referidos'];
      secciones.forEach(sec => {
        document.getElementById(sec).classList.add('hidden');
      });
      document.getElementById('main-menu').classList.remove('hidden');
    }

    async function cargarDatosUsuario() {
      if (!currentUser) return;
      const { data, error } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
      if (!error && data) {
        document.getElementById('nombres').value = data.nombre || '';
        document.getElementById('apellido').value = data.apellido || '';
        document.getElementById('dni').value = data.dni || '';
        document.getElementById('celular').value = data.celular || '';
        document.getElementById('email').value = data.email || currentUser.email;
        document.getElementById('cbu').value = data.cbu || '';
      } else {
        document.getElementById('email').value = currentUser.email;
      }
    }

    async function guardarPerfil() {
      if (!currentUser) return;
      const perfil = {
        id: currentUser.id,
        nombre: document.getElementById('nombres').value,
        apellido: document.getElementById('apellido').value,
        dni: document.getElementById('dni').value,
        celular: document.getElementById('celular').value,
        email: currentUser.email,
        cbu: document.getElementById('cbu').value
      };
      const { error } = await supabase.from('profiles').upsert(perfil, { onConflict: 'id' });
      if (error) {
        alert('Error guardando perfil: ' + error.message);
      } else {
        alert('Perfil guardado correctamente');
        volverMenu();
      }
    }

    function mostrarCuenta() {
      const tipo = document.getElementById('tipo-cuenta').value;
      const campo = document.getElementById('cbu');
      if (tipo === '') {
        campo.placeholder = 'CBU o Dirección USDT';
      } else if (tipo === 'CBU') {
        campo.placeholder = 'CBU';
      } else if (tipo === 'USDT') {
        campo.placeholder = 'Dirección USDT (BEP20)';
      }
    }

    function seleccionarNivel(nivel) {
      selectedNivel = nivel;
      alert('Has seleccionado el nivel: ' + nivel);
      mostrarSeccion('deposito');
    }

    async function guardarDeposito() {
      if (!currentUser) return;
      const metodo = document.getElementById('metodo-deposito').value;
      const monto = parseFloat(document.getElementById('monto-deposito').value);
      const detalle = document.getElementById('detalle-deposito').value;

      if (!metodo || !monto || monto <= 0 || !detalle) {
        alert('Por favor completa todos los campos correctamente');
        return;
      }

      const { error } = await supabase.from('depositos').insert({
        usuario_id: currentUser.id,
        metodo,
        monto,
        detalle,
        fecha: new Date().toISOString(),
        nivel_inversion: selectedNivel
      });

      if (error) {
        alert('Error al guardar depósito: ' + error.message);
      } else {
        alert('Depósito registrado correctamente');
        volverMenu();
      }
    }

    function mostrarCampoRetiro() {
      const tipo = document.getElementById('tipo-retiro').value;
      const campo = document.getElementById('campo-cbu-usdt');
      if (tipo === 'ARS') {
        campo.placeholder = 'CBU';
      } else if (tipo === 'USDT') {
        campo.placeholder = 'Dirección USDT (BEP20)';
      } else {
        campo.placeholder = '';
      }
    }

    async function guardarRetiro() {
      if (!currentUser) return;
      const nombres = document.getElementById('retiro-nombres').value;
      const apellido = document.getElementById('retiro-apellido').value;
      const dni = document.getElementById('retiro-dni').value;
      const tipo = document.getElementById('tipo-retiro').value;
      const monto = parseFloat(document.getElementById('monto-retiro').value);
      const cuenta = document.getElementById('campo-cbu-usdt').value;

      if (!nombres || !apellido || !dni || !tipo || !monto || monto <= 0 || !cuenta) {
        alert('Por favor completa todos los campos correctamente');
        return;
      }

      const { error } = await supabase.from('retiros').insert({
        usuario_id: currentUser.id,
        nombres,
        apellido,
        dni,
        tipo_retiro: tipo,
        monto,
        cuenta,
        fecha_solicitud: new Date().toISOString(),
        estado: 'pendiente'
      });

      if (error) {
        alert('Error al solicitar retiro: ' + error.message);
      } else {
        alert('Retiro solicitado correctamente');
        volverMenu();
      }
    }

    async function cargarLinkReferido() {
      if (!currentUser) return;
      const link = `${window.location.origin}/index.html?referido=${currentUser.id}`;
      document.getElementById('link-referido').value = link;
    }

    async function copiarLink() {
      const input = document.getElementById('link-referido');
      input.select();
      input.setSelectionRange(0, 99999); // Para móviles
      try {
        await navigator.clipboard.writeText(input.value);
        alert('Enlace copiado al portapapeles');
      } catch {
        alert('Error al copiar el enlace');
      }
    }

    async function cargarCantidadReferidos() {
      if (!currentUser) return;
      const { data, error } = await supabase.from('referidos').select('id').eq('referido_por', currentUser.id);
      if (!error && data) {
        document.getElementById('cantidad-referidos').textContent = data.length;
      } else {
        document.getElementById('cantidad-referidos').textContent = '0';
      }
    }

    async function cerrarSesion() {
      const { error } = await supabase.auth.signOut();
      if (error) {
        alert('Error al cerrar sesión: ' + error.message);
      } else {
        window.location.href = 'index.html';
      }
    }

    async function verificarSesion() {
      const { data: { session } } = await supabase.auth.getSession();
      if (session && session.user) {
        currentUser = session.user;
        cargarDatosUsuario();
        mostrarMenuPrincipal();
      } else {
        mostrarLogin();
      }
    }

    verificarSesion();

  </script>
</body>
</html>
