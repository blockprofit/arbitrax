<!DOCTYPE html>  
<html lang="es">  
<head>  
  <meta charset="UTF-8" />  
  <meta name="viewport" content="width=device-width, initial-scale=1" />  
  <title>Trivia Cripto</title>  

  <!-- Agrego favicon -->
  <link rel="icon" href="favicon.png" type="image/png" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />  
  <style>  
    body {  
      margin: 0;  
      font-family: 'Segoe UI', sans-serif;  
      background: url('fondodepantallaprincipal1.jpeg') no-repeat center center fixed;  
      background-size: cover;  
      color: white;  
      min-height: 100vh;  
      overflow-x: hidden;
    }  

    * {
      box-sizing: border-box;
    }
  
    .menu-toggle {  
      position: fixed;  
      top: 15px;  
      left: 15px;  
      font-size: 24px;  
      cursor: pointer;  
      background: rgba(0, 0, 0, 0.8);  
      padding: 12px;  
      border-radius: 8px;  
      z-index: 1000;
      transition: all 0.3s ease;
      border: 2px solid rgba(0, 195, 255, 0.3);
    }  

    .menu-toggle:hover {
      background: rgba(0, 195, 255, 0.2);
      transform: scale(1.05);
    }
  
    .sidebar {  
      width: 250px;  
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(0, 195, 255, 0.1));
      backdrop-filter: blur(15px);
      height: 100vh;  
      padding-top: 60px;  
      display: flex;  
      flex-direction: column;  
      position: fixed;  
      top: 0;  
      left: 0;  
      transform: translateX(-100%);  
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);  
      z-index: 999;
      border-right: 2px solid rgba(0, 195, 255, 0.3);
    }  
  
    .sidebar.active {  
      transform: translateX(0%);  
    }  
  
    .sidebar button {  
      background: none;  
      border: none;  
      color: white;  
      font-size: 15px;  
      padding: 15px 25px;  
      text-align: left;  
      cursor: pointer;  
      width: 100%;  
      display: flex;  
      align-items: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }  
  
    .sidebar button:hover {  
      background: linear-gradient(90deg, rgba(0, 195, 255, 0.2), transparent);
      transform: translateX(5px);
    }

    .sidebar button.active {
      background: linear-gradient(90deg, rgba(0, 195, 255, 0.3), rgba(0, 255, 204, 0.1));
      border-left: 4px solid #00c3ff;
    }
  
    .sidebar button i {  
      margin-right: 15px;  
      width: 20px;  
      text-align: center;
      font-size: 16px;
    }

    .saldo-display {
      position: fixed;
      top: 15px;
      right: 15px;
      background: linear-gradient(135deg, rgba(0, 195, 255, 0.9), rgba(0, 255, 204, 0.7));
      color: black;
      padding: 12px 20px;
      border-radius: 25px;
      font-weight: bold;
      font-size: 16px;
      z-index: 1000;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px rgba(0, 195, 255, 0.3);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }
  
    .main {  
      margin-left: 0;  
      padding: 120px 20px 30px;  
      max-width: 1000px;  
      margin: auto;  
    }  

    .header-section {
      text-align: center;
      margin-bottom: 50px;
      position: relative;
    }

    .main-title {
      font-size: 2.5rem;
      font-weight: 900;
      background: linear-gradient(135deg, #00c3ff, #00ffcc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 20px;
      text-shadow: 0 0 30px rgba(0, 195, 255, 0.5);
      animation: glow 3s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from { filter: brightness(1) drop-shadow(0 0 20px rgba(0, 195, 255, 0.7)); }
      to { filter: brightness(1.2) drop-shadow(0 0 35px rgba(0, 255, 204, 0.9)); }
    }

    .subtitle {
      font-size: 1.2rem;
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 30px;
      animation: fadeInUp 1s ease-out;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(0, 0, 0, 0.6);
      padding: 10px 20px;
      border-radius: 25px;
      margin: 20px 0;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 195, 255, 0.3);
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-dot.active {
      background: #28a745;
      box-shadow: 0 0 15px #28a745;
    }

    .status-dot.inactive {
      background: #dc3545;
      box-shadow: 0 0 15px #dc3545;
    }
  
    .niveles-container {  
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 30px;  
      margin-bottom: 50px;  
      max-width: 900px;
      margin: 0 auto 50px auto;
    }  
  
    .nivel-card {  
      background: linear-gradient(135deg, 
        rgba(0, 195, 255, 0.1), 
        rgba(0, 255, 204, 0.05)
      );
      border: 2px solid rgba(0, 195, 255, 0.4);  
      border-radius: 20px;  
      padding: 30px;  
      text-align: center;  
      cursor: pointer;  
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);  
      user-select: none;  
      position: relative;
      backdrop-filter: blur(15px);
      overflow: hidden;
    }  

    .nivel-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(0, 195, 255, 0.2), transparent);
      transition: left 0.6s ease;
    }

    .nivel-card:hover::before {
      left: 100%;
    }
  
    .nivel-card:hover {  
      background: linear-gradient(135deg, 
        rgba(0, 195, 255, 0.8), 
        rgba(0, 255, 204, 0.6)
      );
      color: #000;  
      transform: translateY(-10px) scale(1.03);
      box-shadow: 0 20px 50px rgba(0, 195, 255, 0.4);
      border-color: #00ffcc;
    }

.nivel-card.selected {
      background: linear-gradient(135deg, #00c3ff, #00ffcc);
      color: #000;
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 15px 40px rgba(0, 195, 255, 0.6);
      border-color: #ffffff;
    }

    .nivel-card.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(1);
    }

    .nivel-card.disabled:hover {
      transform: none;
      background: linear-gradient(135deg, 
        rgba(0, 195, 255, 0.1), 
        rgba(0, 255, 204, 0.05)
      );
      color: white;
    }
  
    .nivel-titulo {  
      font-size: 1.6rem;  
      font-weight: bold;  
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .nivel-icon {
      font-size: 1.8rem;
    }
  
    .nivel-entrada {  
      font-size: 1.3rem;  
      margin-bottom: 12px;
      font-weight: 600;
    }

    .nivel-info {
      font-size: 0.95rem;
      margin-top: 15px;
      opacity: 0.9;
      line-height: 1.4;
    }

    .nivel-multiplicador {
      background: rgba(0, 0, 0, 0.3);
      padding: 8px 15px;
      border-radius: 15px;
      margin-top: 15px;
      font-size: 0.9rem;
      font-weight: bold;
      border: 1px solid rgba(0, 195, 255, 0.3);
    }

    .loader {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255,255,255,.2);
      border-radius: 50%;
      border-top-color: #00c3ff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-message {
      text-align: center;
      margin: 60px 0;
      font-size: 1.1rem;
    }

    .loading-message .loader {
      margin-bottom: 20px;
    }
  
    .btn-iniciar {  
      display: block;  
      margin: 30px auto;  
      padding: 16px 40px;  
      font-size: 1.2rem;  
      font-weight: 700;  
      background: linear-gradient(135deg, #00c3ff, #00ffcc);
      border: none;  
      border-radius: 15px;  
      color: black;  
      cursor: pointer;  
      user-select: none;  
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 10px 30px rgba(0, 195, 255, 0.4);
      position: relative;
      overflow: hidden;
    }  

    .btn-iniciar::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.6s ease;
    }

    .btn-iniciar:hover::before {
      left: 100%;
    }
  
    .btn-iniciar:hover {  
      background: linear-gradient(135deg, #0099cc, #00cc99);
      transform: translateY(-2px);
      box-shadow: 0 15px 40px rgba(0, 195, 255, 0.6);
    }

    .btn-iniciar:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-iniciar:disabled::before {
      display: none;
    }

    .historial-section {
      background: linear-gradient(135deg, 
        rgba(0, 0, 0, 0.8), 
        rgba(0, 195, 255, 0.1)
      );
      backdrop-filter: blur(15px);
      padding: 30px;
      border-radius: 20px;
      margin: 40px 0;
      border: 2px solid rgba(0, 195, 255, 0.3);
      animation: fadeIn 1s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .historial-title {
      color: #00c3ff;
      font-size: 1.6rem;
      font-weight: bold;
      margin-bottom: 25px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .historial-tabs {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .historial-tab {
      background: rgba(0, 195, 255, 0.2);
      border: 2px solid rgba(0, 195, 255, 0.4);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .historial-tab.active {
      background: linear-gradient(135deg, #00c3ff, #00ffcc);
      color: black;
      box-shadow: 0 5px 15px rgba(0, 195, 255, 0.4);
    }

    .historial-content {
      max-height: 400px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(0, 195, 255, 0.5) transparent;
    }

    .historial-content::-webkit-scrollbar {
      width: 6px;
    }

    .historial-content::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    .historial-content::-webkit-scrollbar-thumb {
      background: rgba(0, 195, 255, 0.5);
      border-radius: 3px;
    }

    .ganador-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(90deg, 
        rgba(0, 195, 255, 0.1), 
        rgba(0, 255, 204, 0.05)
      );
      padding: 15px 20px;
      margin: 10px 0;
      border-radius: 12px;
      border-left: 4px solid #00c3ff;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .ganador-item:hover {
      background: linear-gradient(90deg, 
        rgba(0, 195, 255, 0.2), 
        rgba(0, 255, 204, 0.1)
      );
      transform: translateX(5px);
    }

    .ganador-pos {
      font-weight: bold;
      color: #00ffcc;
      width: 40px;
      font-size: 1.1rem;
    }

    .ganador-id {
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      color: #ccc;
      flex: 1;
      margin: 0 15px;
      word-break: break-all;
    }

    .ganador-stats {
      text-align: right;
      font-size: 0.95rem;
    }

    .ganador-premio {
      color: #00ffcc;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .ganador-tiempo {
      color: #aaa;
      font-size: 0.85rem;
      margin-top: 2px;
    }

    .empty-historial {
      text-align: center;
      color: #666;
      padding: 40px;
      font-style: italic;
    }
  </style>  
</head>  
<body>  
  <div class="menu-toggle" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
  </div>

  <div class="saldo-display" id="saldoDisplay">
    <i class="fas fa-wallet"></i> Saldo: <span id="saldoAmount">$0</span>
  </div>
  
  <div class="sidebar" id="sidebar">  
    <button onclick="window.location.href='principal.html#welcome'"><i class="fas fa-home"></i> Inicio</button>  
    <button onclick="window.location.href='principal.html#perfil'"><i class="fas fa-user"></i> Perfil</button>  
    <button onclick="window.location.href='inversion.html'"><i class="fas fa-chart-line"></i> Nivel de inversi√≥n</button>  
    <button onclick="window.location.href='deposito.html'"><i class="fas fa-wallet"></i> Dep√≥sito</button>  
    <button onclick="window.location.href='retiro.html'"><i class="fas fa-hand-holding-usd"></i> Retiro</button>  
    <button onclick="window.location.href='referidos.html'"><i class="fas fa-users"></i> Programa de referidos</button>  
    <button class="active"><i class="fas fa-question"></i> Trivia</button>  
    <button onclick="window.location.href='minipool.html'"><i class="fas fa-coins"></i> Mini Pool</button>  
    <button onclick="window.location.href='mysterybox.html'"><i class="fas fa-box-open"></i> Mystery Box</button>  
    <button onclick="window.location.href='sorteo.html'"><i class="fas fa-gift"></i> Sorteo</button>  
    <button onclick="window.location.href='preguntasfrecuentes.html'"><i class="fas fa-question-circle"></i> Preguntas frecuentes</button>  
    <button onclick="window.location.href='terminosycondiciones.html'"><i class="fas fa-file-contract"></i> T√©rminos y condiciones</button>  
    <button onclick="window.location.href='terminosycondiciones.html'"><i class="fas fa-crown"></i> Panel Admin</button>  
    <button onclick="logout()"><i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n</button>  
  </div>  
  
  <div class="main">  
    <div class="header-section">
      <h1 class="main-title">
        <i class="fas fa-brain"></i>
        TRIVIA CRIPTO
      </h1>
      <div class="subtitle">
        üéØ Gana entre √ó5 y hasta √ó10 de tu entrada ‚Ä¢ üèÜ Demuestra tu conocimiento
      </div>
      <div class="status-indicator" id="statusIndicator">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Verificando estado...</span>
      </div>
    </div>

    <div id="loadingMessage" class="loading-message">
      <div class="loader"></div>
      <p>Cargando niveles y verificando tu saldo...</p>
    </div>

    <div id="errorMessage" class="error-message" style="display: none;"></div>

    <!-- Historial de Ganadores -->
    <div id="historialSection" class="historial-section" style="display: none;">
      <div class="historial-title">
        <i class="fas fa-trophy"></i>
        Ganadores √öltimas 24 Horas
      </div>
      <div class="historial-tabs" id="historialTabs">
        <div class="historial-tab active" data-nivel="basico">
          <i class="fas fa-star"></i> B√°sico
        </div>
        <div class="historial-tab" data-nivel="medio">
          <i class="fas fa-fire"></i> Medio
        </div>
        <div class="historial-tab" data-nivel="avanzado">
          <i class="fas fa-crown"></i> Avanzado
        </div>
      </div>
      <div class="historial-content" id="historialContent">
        <!-- Se carga din√°micamente -->
      </div>
    </div>
  
    <div id="nivelesContainer" class="niveles-container" style="display: none;">
      <!-- Los niveles se cargan din√°micamente -->
    </div>

    <button id="btnIniciar" class="btn-iniciar" disabled style="display: none;">
      <i class="fas fa-play"></i> Iniciar Trivia
    </button>

<div class="pregunta" id="triviaBox" style="display:none">  
      <div class="temporizador">
        <span style="display: flex; align-items: center; gap: 10px;">
          <i class="fas fa-question-circle"></i>
          Pregunta <span id="preguntaNumero">1</span> de <span id="totalPreguntas">10</span>
        </span>
        <span style="display: flex; align-items: center; gap: 8px;">
          <i class="fas fa-clock"></i>
          <span id="tiempo">15</span>s
        </span>
      </div>  
      <div class="progreso">
        <div class="progreso-bar" id="progresoBar"></div>
      </div>
      <div class="pregunta-texto" id="preguntaText">Pregunta aqu√≠</div>  
      <div class="opciones" id="opcionesBox"></div>
      <div style="text-align: center; margin-top: 20px;">
        <button onclick="salirDeTrivia()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
          <i class="fas fa-times"></i> Salir de Trivia
        </button>
      </div>
    </div>  
  
    <div id="resultadoFinal" class="resultado" style="display:none;"></div>  

    <div id="rankingSection" class="ranking-section" style="display:none;">
      <div class="ranking-title">üèÜ Ranking del Nivel</div>
      <div id="rankingContent"></div>
    </div>
  </div>

  <style>
    .pregunta {  
      background: linear-gradient(135deg, 
        rgba(0, 0, 0, 0.9), 
        rgba(0, 195, 255, 0.1)
      );
      backdrop-filter: blur(20px);
      padding: 30px;  
      border-radius: 20px;  
      margin-top: 30px;
      border: 2px solid rgba(0, 195, 255, 0.3);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
    }  
  
    .temporizador {  
      font-size: 1.3rem;  
      font-weight: bold;  
      margin-bottom: 25px;  
      color: #00ffcc;  
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0, 0, 0, 0.5);
      padding: 15px 20px;
      border-radius: 12px;
      border: 1px solid rgba(0, 195, 255, 0.3);
    }

    .progreso {
      background: rgba(255,255,255,0.1);
      height: 12px;
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 25px;
      position: relative;
    }

    .progreso-bar {
      height: 100%;
      background: linear-gradient(90deg, #00c3ff, #00ffcc);
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 6px;
      box-shadow: 0 0 20px rgba(0, 195, 255, 0.5);
    }
  
    .pregunta-texto {  
      font-size: 1.5rem;  
      margin-bottom: 30px;
      line-height: 1.4;
      text-align: center;
      background: rgba(0, 0, 0, 0.3);
      padding: 20px;
      border-radius: 12px;
      border-left: 4px solid #00c3ff;
    }  
  
    .opciones {  
      display: flex;  
      flex-direction: column;  
      gap: 15px;  
    }  
  
    .opciones button {  
      background: linear-gradient(135deg, 
        rgba(34, 34, 34, 0.9), 
        rgba(0, 195, 255, 0.1)
      );
      color: white;  
      border: 2px solid rgba(0, 195, 255, 0.4);  
      border-radius: 12px;  
      padding: 18px 25px;  
      font-size: 1.1rem;  
      cursor: pointer;  
      user-select: none;  
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);  
      text-align: left;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .opciones button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(0, 195, 255, 0.2), transparent);
      transition: left 0.6s ease;
    }

    .opciones button:hover::before {
      left: 100%;
    }
  
    .opciones button:hover {  
      background: linear-gradient(135deg, #00c3ff, rgba(0, 255, 204, 0.8));
      color: black;  
      transform: translateX(10px) scale(1.02);
      box-shadow: 0 10px 25px rgba(0, 195, 255, 0.4);
      border-color: #00ffcc;
    }

    .opciones button.correcta {
      background: linear-gradient(135deg, #28a745, #34ce57);
      border-color: #28a745;
      color: white;
      animation: correcta 0.6s ease;
    }

    .opciones button.incorrecta {
      background: linear-gradient(135deg, #dc3545, #e74c3c);
      border-color: #dc3545;
      color: white;
      animation: incorrecta 0.6s ease;
    }

    @keyframes correcta {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); box-shadow: 0 0 30px #28a745; }
      100% { transform: scale(1); }
    }

    @keyframes incorrecta {
      0% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
      100% { transform: translateX(0); }
    }

    .opciones button:disabled {
      cursor: not-allowed;
      opacity: 0.7;
    }
  
    .resultado {  
      text-align: center;  
      margin-top: 50px;  
      font-size: 1.4rem;  
      background: linear-gradient(135deg, 
        rgba(0, 195, 255, 0.8), 
        rgba(0, 255, 204, 0.6)
      );
      padding: 40px;  
      border-radius: 20px;  
      color: black;  
      font-weight: bold;
      backdrop-filter: blur(15px);
      border: 2px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 20px 50px rgba(0, 195, 255, 0.3);
      animation: resultadoEntrada 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes resultadoEntrada {
      from { 
        opacity: 0; 
        transform: translateY(30px) scale(0.9); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
      }
    }

    .ranking-section {
      background: linear-gradient(135deg, 
        rgba(0, 0, 0, 0.8), 
        rgba(0, 195, 255, 0.1)
      );
      backdrop-filter: blur(15px);
      padding: 30px;
      border-radius: 20px;
      margin-top: 40px;
      border: 2px solid rgba(0, 195, 255, 0.3);
      animation: fadeIn 1s ease-out;
    }

    .ranking-title {
      color: #00c3ff;
      font-size: 1.6rem;
      margin-bottom: 25px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .ranking-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(90deg, 
        rgba(255,255,255,0.1), 
        rgba(0, 195, 255, 0.05)
      );
      padding: 16px 20px;
      margin: 12px 0;
      border-radius: 12px;
      border-left: 4px solid #00c3ff;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .ranking-item:hover {
      background: linear-gradient(90deg, 
        rgba(255,255,255,0.15), 
        rgba(0, 195, 255, 0.1)
      );
      transform: translateX(5px);
    }

    .ranking-item.user-highlight {
      background: linear-gradient(90deg, 
        rgba(0, 195, 255, 0.3), 
        rgba(0, 255, 204, 0.2)
      );
      border-left-color: #00ffcc;
      box-shadow: 0 5px 15px rgba(0, 195, 255, 0.3);
    }

    .ranking-pos {
      font-weight: bold;
      color: #00ffcc;
      width: 40px;
      font-size: 1.2rem;
    }

    .ranking-user {
      flex: 1;
      margin-left: 20px;
      font-weight: 500;
    }

    .ranking-stats {
      text-align: right;
      font-size: 0.95rem;
      color: #ccc;
    }

    .error-message {
      background: linear-gradient(135deg, 
        rgba(220, 53, 69, 0.8), 
        rgba(220, 53, 69, 0.6)
      );
      border: 2px solid #dc3545;
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin: 30px 0;
      text-align: center;
      backdrop-filter: blur(10px);
      animation: shake 0.6s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .success-message {
      background: linear-gradient(135deg, 
        rgba(40, 167, 69, 0.8), 
        rgba(40, 167, 69, 0.6)
      );
      border: 2px solid #28a745;
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin: 30px 0;
      text-align: center;
      backdrop-filter: blur(10px);
      animation: successPulse 0.8s ease-out;
    }

    @keyframes successPulse {
      0% { transform: scale(0.9); opacity: 0; }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); opacity: 1; }
    }

.nivel-pausado {
      position: absolute;
      top: 15px;
      right: 15px;
      background: #dc3545;
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .insufficient-funds {
      background: linear-gradient(135deg, 
        rgba(255, 193, 7, 0.2), 
        rgba(255, 193, 7, 0.1)
      );
      border: 2px solid #ffc107;
      color: #ffc107;
    }

    .insufficient-funds:hover {
      background: linear-gradient(135deg, 
        rgba(255, 193, 7, 0.2), 
        rgba(255, 193, 7, 0.1)
      );
      color: #ffc107;
      transform: none;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .main-title {
        font-size: 2rem;
      }

      .niveles-container {
        grid-template-columns: 1fr;
        max-width: 400px;
      }

      .nivel-card {
        padding: 25px 20px;
      }

      .temporizador {
        font-size: 1.1rem;
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }

      .pregunta-texto {
        font-size: 1.3rem;
      }

      .opciones button {
        padding: 15px 20px;
        font-size: 1rem;
      }

      .historial-tabs {
        flex-direction: column;
        align-items: center;
      }

      .ganador-item {
        flex-direction: column;
        text-align: center;
        gap: 10px;
      }

      .ganador-id {
        margin: 0;
        word-break: break-all;
      }
    }
  </style>
  
  <script>  
    // Configuraci√≥n de Supabase
    const supabaseUrl = "https://ovulezkcxwrjvyxlxsdv.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92dWxlemtjeHdyanZ5eGx4c2R2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNzY5OTksImV4cCI6MjA2NDY1Mjk5OX0.ac82tkUR7AT0QVsuzuAGA8SXLkgnM9OX62meYNGnToI";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    // Variables globales
    let preguntas = [], actual = 0, tiempo = 15, timer = null, correctas = 0;
    let nivelSeleccionado = null, tiempoInicio = null, totalPreguntas = 0;
    let usuarioActual = null, saldoUsuario = 0;
    let triviaEnCurso = false;

    // Elementos DOM
    const loadingMessage = document.getElementById('loadingMessage');
    const errorMessage = document.getElementById('errorMessage');
    const nivelesContainer = document.getElementById('nivelesContainer');
    const btnIniciar = document.getElementById('btnIniciar');
    const triviaBox = document.getElementById('triviaBox');
    const preguntaText = document.getElementById('preguntaText');
    const opcionesBox = document.getElementById('opcionesBox');
    const tiempoDisplay = document.getElementById('tiempo');
    const resultadoFinal = document.getElementById('resultadoFinal');
    const rankingSection = document.getElementById('rankingSection');
    const preguntaNumero = document.getElementById('preguntaNumero');
    const totalPreguntasSpan = document.getElementById('totalPreguntas');
    const progresoBar = document.getElementById('progresoBar');
    const saldoDisplay = document.getElementById('saldoAmount');
    const statusIndicator = document.getElementById('statusIndicator');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const historialSection = document.getElementById('historialSection');

    // Inicializar aplicaci√≥n
    async function inicializarApp() {
      try {
        await verificarUsuario();
        await cargarSaldoUsuario();
        await verificarEstadoEventos();
        await cargarNivelesYPrecios();
        await cargarHistorialGanadores();
        
        loadingMessage.style.display = 'none';
        historialSection.style.display = 'block';
        nivelesContainer.style.display = 'grid';
        btnIniciar.style.display = 'block';
      } catch (error) {
        console.error('Error inicializando app:', error);
        mostrarError('Error al cargar la aplicaci√≥n. Por favor, recarga la p√°gina.');
      }
    }

    async function verificarUsuario() {
      const { data: { user }, error } = await supabaseClient.auth.getUser();
      
      if (error || !user) {
        mostrarError('No est√°s autenticado. Por favor, inicia sesi√≥n.');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 3000);
        return;
      }

      // Obtener datos del usuario desde profiles
      const { data: profile, error: profileError } = await supabaseClient
        .from('profiles')
        .select('*')
        .eq('id', user.id)
        .single();

      if (profileError || !profile) {
        mostrarError('Error al obtener datos del usuario.');
        return;
      }

      usuarioActual = {
        id: user.id,
        email: user.email,
        nombre: profile.username || profile.email || 'Usuario'
      };
    }

    // NUEVA FUNCI√ìN: Cargar saldo del usuario
    async function cargarSaldoUsuario() {
      try {
        const { data: balance, error } = await supabaseClient
          .from('balances')
          .select('saldo')
          .eq('usuario_id', usuarioActual.id)
          .maybeSingle();

        if (error) {
          console.error('Error al cargar saldo:', error);
          saldoUsuario = 0;
        } else {
          saldoUsuario = balance?.saldo || 0;
        }

        saldoDisplay.textContent = `$${saldoUsuario.toLocaleString()}`;
        
        // Animar el saldo
        saldoDisplay.style.animation = 'none';
        setTimeout(() => {
          saldoDisplay.style.animation = 'pulse 2s infinite';
        }, 100);

      } catch (error) {
        console.error('Error cargando saldo:', error);
        saldoUsuario = 0;
        saldoDisplay.textContent = '$0';
      }
    }

    // NUEVA FUNCI√ìN: Verificar estado de eventos desde admin
    async function verificarEstadoEventos() {
      try {
        const { data: eventos, error } = await supabaseClient
          .from('eventos_trivia')
          .select('*')
          .eq('estado', 'activo');

        if (error) {
          console.error('Error verificando eventos:', error);
          mostrarEstadoSistema(false, 'Error al verificar estado del sistema');
          return;
        }

        const hayEventosActivos = eventos && eventos.length > 0;
        mostrarEstadoSistema(hayEventosActivos, 
          hayEventosActivos ? 
            `‚úÖ Sistema activo - ${eventos.length} nivel(es) disponible(s)` : 
            '‚è∏Ô∏è Sistema pausado por mantenimiento'
        );

        return hayEventosActivos;
        
      } catch (error) {
        console.error('Error verificando eventos:', error);
        mostrarEstadoSistema(false, 'Error de conexi√≥n');
        return false;
      }
    }

    function mostrarEstadoSistema(activo, mensaje) {
      if (activo) {
        statusDot.className = 'status-dot active';
        statusText.textContent = mensaje;
        statusIndicator.style.borderColor = 'rgba(40, 167, 69, 0.5)';
      } else {
        statusDot.className = 'status-dot inactive';
        statusText.textContent = mensaje;
        statusIndicator.style.borderColor = 'rgba(220, 53, 69, 0.5)';
      }
    }

    // NUEVA FUNCI√ìN: Verificar si un nivel espec√≠fico est√° activo
    async function verificarNivelActivo(nivel) {
      try {
        const { data: evento, error } = await supabaseClient
          .from('eventos_trivia')
          .select('*')
          .eq('nivel', nivel)
          .eq('estado', 'activo')
          .maybeSingle();

        return !error && evento;
      } catch (error) {
        return false;
      }
    }

    async function cargarNivelesYPrecios() {
      const { data: niveles, error } = await supabaseClient
        .from('niveles_trivia')
        .select('*')
        .order('precio', { ascending: true });

      if (error) {
        mostrarError('Error al cargar los niveles: ' + error.message);
        return;
      }

      if (!niveles || niveles.length === 0) {
        mostrarError('No hay niveles configurados. Contacta al administrador.');
        return;
      }

      await mostrarNiveles(niveles);
    }

    async function mostrarNiveles(niveles) {
      nivelesContainer.innerHTML = '';
      
      const limitesPreguntas = {
        'basico': { max: 10, tiempo: 15, icon: 'fas fa-star', multiplicador: '√ó5-√ó6' },
        'medio': { max: 12, tiempo: 15, icon: 'fas fa-fire', multiplicador: '√ó6-√ó8' },
        'avanzado': { max: 15, tiempo: 15, icon: 'fas fa-crown', multiplicador: '√ó8-√ó10' }
      };

      for (const nivel of niveles) {
        const limite = limitesPreguntas[nivel.nombre] || { max: 10, tiempo: 15, icon: 'fas fa-question', multiplicador: '√ó5' };
        
        // Verificar si el nivel est√° activo
        const nivelActivo = await verificarNivelActivo(nivel.nombre);
        const tieneSaldo = saldoUsuario >= nivel.precio;
        
        const card = document.createElement('div');
        card.className = 'nivel-card';
        
        if (!nivelActivo) {
          card.classList.add('disabled');
        } else if (!tieneSaldo) {
          card.classList.add('insufficient-funds');
        }
        
        card.setAttribute('data-nivel', nivel.nombre);
        card.setAttribute('data-precio', nivel.precio);
        card.setAttribute('data-tiempo', limite.tiempo);
        card.setAttribute('data-activo', nivelActivo);
        card.setAttribute('data-tiene-saldo', tieneSaldo);
        
        card.innerHTML = `
          ${!nivelActivo ? '<div class="nivel-pausado"><i class="fas fa-pause"></i> PAUSADO</div>' : ''}
          <div class="nivel-titulo">
            <i class="${limite.icon} nivel-icon"></i>
            ${nivel.nombre.charAt(0).toUpperCase() + nivel.nombre.slice(1)}
          </div>
          <div class="nivel-entrada">
            <i class="fas fa-ticket-alt"></i>
            Entrada: $${nivel.precio.toLocaleString()} ARS
          </div>
          <div class="nivel-info">
            <i class="fas fa-question-circle"></i> ${limite.max} preguntas<br>
            <i class="fas fa-clock"></i> ${limite.tiempo}s por pregunta<br>
            <i class="fas fa-chart-line"></i> Ganancia: ${limite.multiplicador}
          </div>
          <div class="nivel-multiplicador">
            ${!tieneSaldo ? '<i class="fas fa-exclamation-triangle"></i> Saldo insuficiente' : 
              !nivelActivo ? '<i class="fas fa-pause"></i> Nivel pausado' : 
              `<i class="fas fa-coins"></i> Ganancia potencial: ${limite.multiplicador}`
            }
          </div>
        `;
        
        if (nivelActivo && tieneSaldo) {
          card.addEventListener('click', () => seleccionarNivel(card));
        }
        
        nivelesContainer.appendChild(card);
      }
    }

    function seleccionarNivel(card) {
      const nivelActivo = card.getAttribute('data-activo') === 'true';
      const tieneSaldo = card.getAttribute('data-tiene-saldo') === 'true';
      
      if (!nivelActivo || !tieneSaldo) {
        if (!nivelActivo) {
          mostrarError('‚ùå Este nivel est√° pausado por mantenimiento. Intenta m√°s tarde.');
        } else {
          mostrarError('üí∞ Saldo insuficiente. Necesitas recargar tu cuenta.');
        }
        return;
      }

      // Resetear estilos
      document.querySelectorAll('.nivel-card').forEach(c => {
        c.classList.remove('selected');
      });
      
      // Marcar seleccionado
      card.classList.add('selected');
      
      nivelSeleccionado = {
        nombre: card.getAttribute('data-nivel'),
        precio: parseInt(card.getAttribute('data-precio')),
        tiempo: parseInt(card.getAttribute('data-tiempo'))
      };
      
      btnIniciar.disabled = false;
      btnIniciar.innerHTML = `
        <i class="fas fa-rocket"></i>
        Iniciar ${nivelSeleccionado.nombre.charAt(0).toUpperCase() + nivelSeleccionado.nombre.slice(1)}
        (Costo: $${nivelSeleccionado.precio.toLocaleString()})
      `;

      // Scroll suave al bot√≥n
      btnIniciar.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

async function cargarPreguntasDelNivel(nivel) {
      const { data: preguntasDB, error } = await supabaseClient
        .from('preguntas_trivia')
        .select('*')
        .eq('nivel', nivel)
        .order('created_at', { ascending: true });

      if (error) {
        throw new Error('Error al cargar preguntas: ' + error.message);
      }

      if (!preguntasDB || preguntasDB.length === 0) {
        throw new Error(`No hay preguntas disponibles para el nivel ${nivel}. Contacta al administrador.`);
      }

      return preguntasDB.map(p => ({
        id: p.id,
        pregunta: p.texto,
        opciones: p.opciones,
        respuestaCorrecta: p.correcta
      }));
    }

    // NUEVA FUNCI√ìN: Descontar saldo al iniciar trivia
    async function descontarSaldo(precio) {
      try {
        const nuevoSaldo = saldoUsuario - precio;
        
        const { error } = await supabaseClient
          .from('balances')
          .update({ saldo: nuevoSaldo })
          .eq('usuario_id', usuarioActual.id);

        if (error) {
          throw new Error('Error al descontar saldo: ' + error.message);
        }

        saldoUsuario = nuevoSaldo;
        saldoDisplay.textContent = `$${saldoUsuario.toLocaleString()}`;
        
        // Animaci√≥n de descuento
        saldoDisplay.style.animation = 'shake 0.6s ease-in-out';
        setTimeout(() => {
          saldoDisplay.style.animation = 'pulse 2s infinite';
        }, 600);

        return true;
      } catch (error) {
        console.error('Error descontando saldo:', error);
        throw error;
      }
    }

    // NUEVA FUNCI√ìN: Salir de trivia (pierde entrada)
    function salirDeTrivia() {
      if (!triviaEnCurso) return;

      if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres salir?\n\nüö® Perder√°s tu entrada y tendr√°s que pagar nuevamente para jugar.')) {
        clearInterval(timer);
        triviaEnCurso = false;
        
        // Mostrar mensaje de penalizaci√≥n
        mostrarError('‚ùå Has salido de la trivia. Tu entrada se ha perdido. Debes pagar nuevamente para jugar.');
        
        // Volver al inicio
        volverAlInicio();
        
        // Recargar saldo por si acaso
        setTimeout(() => {
          cargarSaldoUsuario();
        }, 1000);
      }
    }

    btnIniciar.addEventListener('click', async () => {
      if (!nivelSeleccionado) return;
      
      btnIniciar.disabled = true;
      btnIniciar.innerHTML = '<div class="loader"></div> Verificando y procesando pago...';
      
      try {
        // Verificar nuevamente el nivel y saldo
        const nivelActivo = await verificarNivelActivo(nivelSeleccionado.nombre);
        if (!nivelActivo) {
          throw new Error('‚ùå Este nivel ha sido pausado. No se puede iniciar la trivia.');
        }

        // Verificar saldo actualizado
        await cargarSaldoUsuario();
        if (saldoUsuario < nivelSeleccionado.precio) {
          throw new Error('üí∞ Saldo insuficiente. Tu saldo ha cambiado.');
        }

        // Descontar saldo ANTES de cargar preguntas
        await descontarSaldo(nivelSeleccionado.precio);
        
        mostrarExito(`‚úÖ Pago procesado: $${nivelSeleccionado.precio.toLocaleString()} descontados de tu saldo`);
        
        btnIniciar.innerHTML = '<div class="loader"></div> Cargando preguntas...';
        
        // Cargar preguntas
        preguntas = await cargarPreguntasDelNivel(nivelSeleccionado.nombre);
        totalPreguntas = preguntas.length;
        
        // Resetear variables
        actual = 0;
        correctas = 0;
        tiempoInicio = Date.now();
        triviaEnCurso = true;
        
        // Mostrar interfaz de juego
        nivelesContainer.style.display = 'none';
        btnIniciar.style.display = 'none';
        historialSection.style.display = 'none';
        triviaBox.style.display = 'block';
        totalPreguntasSpan.textContent = totalPreguntas;
        
        mostrarPregunta();
      } catch (error) {
        mostrarError(error.message);
        btnIniciar.disabled = false;
        btnIniciar.innerHTML = `
          <i class="fas fa-rocket"></i>
          Iniciar ${nivelSeleccionado ? nivelSeleccionado.nombre.charAt(0).toUpperCase() + nivelSeleccionado.nombre.slice(1) : 'Trivia'}
        `;
      }
    });

    function mostrarPregunta() {
      if (actual >= preguntas.length) {
        return terminarTrivia();
      }

      const p = preguntas[actual];
      preguntaNumero.textContent = actual + 1;
      preguntaText.textContent = p.pregunta;
      
      // Actualizar barra de progreso
      const progreso = ((actual + 1) / totalPreguntas) * 100;
      progresoBar.style.width = progreso + '%';
      
      // Crear opciones con animaci√≥n
      opcionesBox.innerHTML = '';
      p.opciones.forEach((opcion, index) => {
        const btn = document.createElement('button');
        btn.textContent = `${String.fromCharCode(65 + index)}. ${opcion}`;
        btn.onclick = () => responderPregunta(index);
        btn.style.opacity = '0';
        btn.style.transform = 'translateY(20px)';
        opcionesBox.appendChild(btn);
        
        // Animaci√≥n de entrada
        setTimeout(() => {
          btn.style.transition = 'all 0.4s ease';
          btn.style.opacity = '1';
          btn.style.transform = 'translateY(0)';
        }, index * 100);
      });

      // Iniciar temporizador
      tiempo = nivelSeleccionado.tiempo;
      tiempoDisplay.textContent = tiempo;
      clearInterval(timer);
      
      timer = setInterval(() => {
        tiempo--;
        tiempoDisplay.textContent = tiempo;
        
        if (tiempo <= 5) {
          tiempoDisplay.style.color = '#ff6b7a';
          tiempoDisplay.style.animation = 'pulse 0.5s infinite';
        } else {
          tiempoDisplay.style.color = '#00ffcc';
          tiempoDisplay.style.animation = 'none';
        }
        
        if (tiempo <= 0) {
          clearInterval(timer);
          responderPregunta(-1); // Tiempo agotado
        }
      }, 1000);
    }

    function responderPregunta(indiceSeleccionado) {
      clearInterval(timer);
      const p = preguntas[actual];
      const botones = opcionesBox.querySelectorAll('button');
      
      // Deshabilitar todos los botones
      botones.forEach(btn => btn.disabled = true);
      
      // Mostrar respuesta correcta e incorrecta
      botones.forEach((btn, index) => {
        if (index === p.respuestaCorrecta) {
          btn.classList.add('correcta');
        } else if (index === indiceSeleccionado && index !== p.respuestaCorrecta) {
          btn.classList.add('incorrecta');
        }
      });

// Verificar si es correcta
      if (indiceSeleccionado === p.respuestaCorrecta) {
        correctas++;
      }
      
      // Avanzar despu√©s de 2 segundos
      setTimeout(() => {
        actual++;
        mostrarPregunta();
      }, 2500);
    }

    async function terminarTrivia() {
      triviaEnCurso = false;
      const tiempoTotal = Math.round((Date.now() - tiempoInicio) / 1000);
      const porcentajeAciertos = (correctas / totalPreguntas * 100).toFixed(1);
      
      // Calcular premio basado en porcentaje
      let multiplicador = 0;
      if (porcentajeAciertos >= 90) multiplicador = 10;
      else if (porcentajeAciertos >= 80) multiplicador = 8;
      else if (porcentajeAciertos >= 70) multiplicador = 6;
      else if (porcentajeAciertos >= 60) multiplicador = 5;
      else if (porcentajeAciertos >= 50) multiplicador = 3;
      
      const premioBase = Math.round(nivelSeleccionado.precio * multiplicador);
      const premio = Math.round(premioBase * 0.5); // 50% para premios como define el admin
      
      try {
        // Guardar resultado en ranking_trivia
        await guardarResultado(tiempoTotal, premio);
        
        // Mostrar resultado con animaciones
        triviaBox.style.display = 'none';
        resultadoFinal.style.display = 'block';
        
        const iconoResultado = premio > 0 ? 'üèÜ' : 'üí™';
        const mensajeResultado = premio > 0 ? 
          '¬°Felicidades! Has ganado un premio' : 
          '¬°Sigue practicando para obtener mejores resultados!';
        
        resultadoFinal.innerHTML = `
          <div style="font-size: 3rem; margin-bottom: 20px;">${iconoResultado}</div>
          <h2>¬°Trivia Completada!</h2>
          <div style="margin: 30px 0; font-size: 1.2rem; line-height: 1.6;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 400px; margin: 0 auto;">
              <div><strong>Nivel:</strong><br>${nivelSeleccionado.nombre.charAt(0).toUpperCase() + nivelSeleccionado.nombre.slice(1)}</div>
              <div><strong>Tiempo:</strong><br>${tiempoTotal}s</div>
              <div><strong>Aciertos:</strong><br>${correctas}/${totalPreguntas} (${porcentajeAciertos}%)</div>
              <div><strong>Premio:</strong><br><span style="color: #00ffcc; font-size: 1.3em;">$${premio.toLocaleString()}</span></div>
            </div>
          </div>
          <div style="color: ${premio > 0 ? '#00ffcc' : '#ffc107'}; font-size: 1.1rem; margin: 20px 0; font-weight: bold;">
            ${mensajeResultado}
          </div>
          ${premio > 0 ? '<div style="font-size: 0.9rem; opacity: 0.8; margin-top: 15px;">üí° Tu premio estar√° disponible una vez que sea aprobado por el administrador</div>' : ''}
        `;
        
        // Cargar y mostrar ranking
        await cargarRankingNivel();
        
        // Bot√≥n para volver despu√©s de unos segundos
        setTimeout(() => {
          const btnVolver = document.createElement('button');
          btnVolver.textContent = 'üîÑ Jugar de Nuevo';
          btnVolver.className = 'btn-iniciar';
          btnVolver.style.marginTop = '30px';
          btnVolver.onclick = volverAlInicio;
          resultadoFinal.appendChild(btnVolver);
        }, 3000);
        
        // Actualizar saldo mostrado
        await cargarSaldoUsuario();
        
      } catch (error) {
        mostrarError('Error al guardar el resultado: ' + error.message);
      }
    }

    async function guardarResultado(tiempoTotal, premio) {
      const { error } = await supabaseClient
        .from('ranking_trivia')
        .insert([{
          usuario_id: usuarioActual.id,
          usuario_nombre: usuarioActual.nombre,
          nivel: nivelSeleccionado.nombre,
          acertadas: correctas,
          tiempo: tiempoTotal,
          premio: premio,
          premio_liberado: false
        }]);

      if (error) {
        throw error;
      }
    }

    async function cargarRankingNivel() {
      try {
        const { data: ranking, error } = await supabaseClient
          .from('ranking_trivia')
          .select('*')
          .eq('nivel', nivelSeleccionado.nombre)
          .order('acertadas', { ascending: false })
          .order('tiempo', { ascending: true })
          .limit(10);

        if (error) throw error;

        rankingSection.style.display = 'block';
        const rankingContent = document.getElementById('rankingContent');
        
        if (!ranking || ranking.length === 0) {
          rankingContent.innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px;">No hay datos en el ranking a√∫n</div>';
          return;
        }

        rankingContent.innerHTML = '';
        ranking.forEach((item, index) => {
          const div = document.createElement('div');
          div.className = 'ranking-item';
          
          const esUsuarioActual = item.usuario_id === usuarioActual.id;
          if (esUsuarioActual) {
            div.classList.add('user-highlight');
          }
          
          const medallaIcon = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}¬∞`;
          
          div.innerHTML = `
            <div class="ranking-pos">${medallaIcon}</div>
            <div class="ranking-user">
              ${esUsuarioActual ? 'üë§ ' : ''}${item.usuario_nombre}
              ${esUsuarioActual ? ' (T√∫)' : ''}
            </div>
            <div class="ranking-stats">
              ‚úÖ ${item.acertadas} aciertos ‚Ä¢ ‚è±Ô∏è ${item.tiempo}s<br>
              <span class="ganador-premio">üí∞ $${item.premio.toLocaleString()}</span>
            </div>
          `;
          
          rankingContent.appendChild(div);
        });
        
      } catch (error) {
        console.error('Error cargando ranking:', error);
      }
    }

    // NUEVA FUNCI√ìN: Cargar historial de ganadores √∫ltimas 24h
    async function cargarHistorialGanadores() {
      const hace24Horas = new Date();
      hace24Horas.setHours(hace24Horas.getHours() - 24);

      try {
        const { data: ganadores, error } = await supabaseClient
          .from('ranking_trivia')
          .select('*')
          .gte('created_at', hace24Horas.toISOString())
          .gt('premio', 0) // Solo ganadores con premio
          .order('created_at', { ascending: false });

        if (error) throw error;

        // Configurar tabs del historial
        configurarHistorialTabs(ganadores || []);
        
        // Cargar nivel b√°sico por defecto
        mostrarHistorialNivel('basico', ganadores || []);
        
      } catch (error) {
        console.error('Error cargando historial:', error);
      }
    }

    function configurarHistorialTabs(ganadores) {
      const tabs = document.querySelectorAll('.historial-tab');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // Remover active de todos
          tabs.forEach(t => t.classList.remove('active'));
          // Activar el clickeado
          tab.classList.add('active');
          
          const nivel = tab.getAttribute('data-nivel');
          mostrarHistorialNivel(nivel, ganadores);
        });
      });
    }

    function mostrarHistorialNivel(nivel, ganadores) {
      const historialContent = document.getElementById('historialContent');
      const ganadoresNivel = ganadores.filter(g => g.nivel === nivel);
      
      if (ganadoresNivel.length === 0) {
        historialContent.innerHTML = `
          <div class="empty-historial">
            <i class="fas fa-trophy" style="font-size: 3rem; opacity: 0.3; margin-bottom: 20px;"></i>
            <p>No hay ganadores en las √∫ltimas 24 horas para el nivel ${nivel}</p>
          </div>
        `;
        return;
      }

      historialContent.innerHTML = '';
      ganadoresNivel.forEach((ganador, index) => {
        const tiempoHace = calcularTiempoTranscurrido(ganador.created_at);
        const medallaIcon = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}¬∞`;
        
        const div = document.createElement('div');
        div.className = 'ganador-item';
        
        div.innerHTML = `
          <div class="ganador-pos">${medallaIcon}</div>
          <div class="ganador-id">${ganador.usuario_id}</div>
          <div class="ganador-stats">
            <div class="ganador-premio">$${ganador.premio.toLocaleString()}</div>
            <div class="ganador-tiempo">${tiempoHace}</div>
          </div>
        `;
        
        historialContent.appendChild(div);
      });
    }

    function calcularTiempoTranscurrido(fecha) {
      const ahora = new Date();
      const fechaCreacion = new Date(fecha);
      const diferencia = ahora - fechaCreacion;
      
      const minutos = Math.floor(diferencia / (1000 * 60));
      const horas = Math.floor(diferencia / (1000 * 60 * 60));
      
      if (minutos < 60) {
        return `Hace ${minutos} min`;
      } else {
        return `Hace ${horas} h`;
      }
    }

    function volverAlInicio() {
      resultadoFinal.style.display = 'none';
      rankingSection.style.display = 'none';
      triviaBox.style.display = 'none';
      historialSection.style.display = 'block';
      nivelesContainer.style.display = 'grid';
      btnIniciar.style.display = 'block';
      btnIniciar.disabled = true;
      btnIniciar.innerHTML = '<i class="fas fa-play"></i> Iniciar Trivia';
      nivelSeleccionado = null;
      triviaEnCurso = false;
      
      // Resetear estilos de tarjetas
      document.querySelectorAll('.nivel-card').forEach(c => {
        c.classList.remove('selected');
      });
      
      // Recargar datos
      cargarSaldoUsuario();
      cargarNivelesYPrecios();
      cargarHistorialGanadores();
    }

    function mostrarError(mensaje) {
      errorMessage.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${mensaje}`;
      errorMessage.style.display = 'block';
      loadingMessage.style.display = 'none';
      
      setTimeout(() => {
        errorMessage.style.display = 'none';
      }, 8000);
    }

    function mostrarExito(mensaje) {
      const successDiv = document.createElement('div');
      successDiv.className = 'success-message';
      successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${mensaje}`;
      document.querySelector('.main').insertBefore(successDiv, nivelesContainer);
      
      setTimeout(() => {
        successDiv.remove();
      }, 5000);
    }

    function toggleSidebar() {  
      document.getElementById("sidebar").classList.toggle("active");  
    }  
  
    function logout() {  
      if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
        supabaseClient.auth.signOut().then(() => {
          window.location.href = 'index.html';
        });
      }
    }

    // Detectar cuando el usuario sale de la p√°gina (cierra, cambia de pesta√±a, etc.)
    window.addEventListener('beforeunload', (event) => {
      if (triviaEnCurso) {
        event.preventDefault();
        event.returnValue = '‚ö†Ô∏è Si sales ahora, perder√°s tu entrada pagada. ¬øEst√°s seguro?';
        return event.returnValue;
      }
    });

    // Detectar cuando el usuario regresa a la p√°gina
    document.addEventListener('visibilitychange', () => {
      if (triviaEnCurso && document.visibilityState === 'visible') {
        // Si regresa durante la trivia, considerar como interrupci√≥n
        clearInterval(timer);
        mostrarError('‚ùå La trivia se interrumpi√≥ al cambiar de pesta√±a. Tu entrada se ha perdido.');
        volverAlInicio();
      }
    });

    // Inicializar la aplicaci√≥n cuando cargue la p√°gina
    document.addEventListener('DOMContentLoaded', inicializarApp);

    // Manejar errores de autenticaci√≥n
    supabaseClient.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_OUT') {
        window.location.href = 'index.html';
      }
    });

    // Actualizar datos cada 30 segundos cuando no est√° en trivia
    setInterval(() => {
      if (!triviaEnCurso) {
        verificarEstadoEventos();
        cargarSaldoUsuario();
      }
    }, 30000);

  </script>  
</body>  
</html>
