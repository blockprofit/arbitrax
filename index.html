<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login con Email - Supabase</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png" />

  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="Arbitrax - Plataforma de inversión cripto" />
  <meta property="og:description" content="Invertí y multiplicá tu capital con nuestras funciones: inversión, trivia, mini pool y más." />
  <meta property="og:image" content="https://res.cloudinary.com/dghk6h3es/image/upload/v1750960886/arbitrax-preview_sywhbe.jpg" />
  <meta property="og:url" content="https://arbitrax-livid.vercel.app/" />
  <meta property="og:type" content="website" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Arbitrax - Plataforma de inversión cripto">
  <meta name="twitter:description" content="Sumate al ecosistema de inversión más dinámico y transparente.">
  <meta name="twitter:image" content="https://res.cloudinary.com/dghk6h3es/image/upload/v1750960886/arbitrax-preview_sywhbe.jpg">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  
  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Segoe UI', sans-serif;
    }

    body {
      background: url('https://github.com/blockprofit/arbitrax/blob/main/fondodepantallainicio.jpeg?raw=true') no-repeat center center fixed;
      background-size: cover;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: white;
      position: relative;
    }

    /* Logo ArbitraX */
    .logo-container {
      position: absolute;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 4rem;
      font-weight: 900;
      background: linear-gradient(135deg, #00c3ff, #00ffcc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 30px rgba(0, 195, 255, 0.5);
      animation: logoGlow 3s ease-in-out infinite alternate;
      letter-spacing: 2px;
    }

    @keyframes logoGlow {
      from { 
        filter: brightness(1) drop-shadow(0 0 20px rgba(0, 195, 255, 0.7)); 
      }
      to { 
        filter: brightness(1.2) drop-shadow(0 0 35px rgba(0, 255, 204, 0.9)); 
      }
    }

    /* Logo flotante ArbitraX arriba del cuadro */
    .floating-logo {
      position: absolute;
      top: -70px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 3rem;
      font-weight: 900;
      background: linear-gradient(135deg, #00c3ff, #00ffcc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 30px rgba(0, 195, 255, 0.5);
      animation: floatingGlow 3s ease-in-out infinite alternate;
      letter-spacing: 2px;
      z-index: 3;
    }

    @keyframes floatingGlow {
      from { 
        filter: brightness(1) drop-shadow(0 0 20px rgba(0, 195, 255, 0.7)); 
        transform: translateX(-50%) translateY(0px);
      }
      to { 
        filter: brightness(1.2) drop-shadow(0 0 35px rgba(0, 255, 204, 0.9)); 
        transform: translateX(-50%) translateY(-8px);
      }
    }

    .login-container {
      background: linear-gradient(135deg, 
        rgba(0, 0, 0, 0.85), 
        rgba(0, 195, 255, 0.1)
      );
      backdrop-filter: blur(20px);
      border: 2px solid rgba(0, 195, 255, 0.3);
      border-radius: 20px;
      padding: 40px 35px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.6);
      position: relative;
      transition: all 0.3s ease;
      margin-top: 80px;
    }

    .login-container:hover {
      border-color: rgba(0, 255, 204, 0.4);
      box-shadow: 0 30px 80px rgba(0, 195, 255, 0.3);
    }

    .language-menu {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 10;
    }

    .language-menu button {
      background: linear-gradient(135deg, rgba(0, 195, 255, 0.2), rgba(0, 255, 204, 0.1));
      border: 2px solid rgba(0, 195, 255, 0.3);
      padding: 8px 12px;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      color: white;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      font-size: 0.9rem;
      min-width: 80px;
    }

    .language-menu button:hover {
      background: linear-gradient(135deg, rgba(0, 195, 255, 0.3), rgba(0, 255, 204, 0.2));
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 195, 255, 0.3);
    }

    .language-menu ul {
      display: none;
      position: absolute;
      top: 45px;
      right: 0;
      list-style: none;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(0, 195, 255, 0.1));
      backdrop-filter: blur(15px);
      border: 2px solid rgba(0, 195, 255, 0.3);
      border-radius: 12px;
      padding: 8px 0;
      margin: 0;
      width: 120px;
      z-index: 99;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .language-menu ul li {
      padding: 12px 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
      color: white;
      font-size: 0.9rem;
    }

    .language-menu ul li:hover {
      background: linear-gradient(90deg, rgba(0, 195, 255, 0.2), transparent);
    }

    h2 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 2rem;
      font-weight: 700;
      background: linear-gradient(135deg, #00c3ff, #00ffcc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 20px rgba(0, 195, 255, 0.5);
    }

    input {
      width: 100%;
      padding: 16px 20px;
      margin: 15px 0;
      border: 2px solid rgba(0, 195, 255, 0.4);
      border-radius: 12px;
      font-size: 16px;
      background: linear-gradient(135deg, 
        rgba(34, 34, 34, 0.9), 
        rgba(0, 195, 255, 0.1)
      );
      color: white;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    input:focus {
      outline: none;
      border-color: #00ffcc;
      background: linear-gradient(135deg, 
        rgba(0, 195, 255, 0.2), 
        rgba(0, 255, 204, 0.1)
      );
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 195, 255, 0.3);
    }

    button {
      width: 100%;
      padding: 16px 20px;
      margin: 20px 0 10px 0;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(135deg, #00c3ff, #00ffcc);
      color: black;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 10px 30px rgba(0, 195, 255, 0.4);
      position: relative;
      overflow: hidden;
    }

    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.6s ease;
    }

    button:hover::before {
      left: 100%;
    }

    button:hover {
      background: linear-gradient(135deg, #0099cc, #00cc99);
      transform: translateY(-2px);
      box-shadow: 0 15px 40px rgba(0, 195, 255, 0.6);
    }

    .form-switch {
      text-align: center;
      margin-top: 20px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
    }

    .form-switch a {
      color: #00c3ff;
      text-decoration: none;
      cursor: pointer;
      display: inline-block;
      margin: 5px 8px;
      font-weight: bold;
      transition: all 0.3s ease;
      padding: 5px 10px;
      border-radius: 6px;
    }

    .form-switch a:hover {
      color: #00ffcc;
      background: rgba(0, 195, 255, 0.1);
      transform: translateY(-1px);
    }

    .hidden {
      display: none;
    }

    /* Loading animation */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .loading button {
      background: linear-gradient(135deg, #666, #888);
      cursor: not-allowed;
    }

    /* Success/Error messages */
    .message {
      padding: 12px 16px;
      margin: 15px 0;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }

    .message.show {
      opacity: 1;
      transform: translateY(0);
    }

    .message.success {
      background: linear-gradient(135deg, rgba(0, 255, 204, 0.2), rgba(0, 195, 255, 0.1));
      border: 2px solid rgba(0, 255, 204, 0.4);
      color: #00ffcc;
    }

    .message.error {
      background: linear-gradient(135deg, rgba(255, 100, 100, 0.2), rgba(255, 50, 50, 0.1));
      border: 2px solid rgba(255, 100, 100, 0.4);
      color: #ff6666;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .floating-logo {
        font-size: 2.2rem;
        top: -60px;
      }

      .login-container {
        margin: 20px;
        margin-top: 80px;
        padding: 30px 25px;
        max-width: 350px;
      }

      .language-menu {
        top: 15px;
        right: 15px;
      }

      .language-menu button {
        padding: 6px 8px;
        font-size: 0.8rem;
        min-width: 70px;
      }

      .language-menu ul {
        width: 100px;
        top: 38px;
      }

      .language-menu ul li {
        padding: 10px 12px;
        font-size: 0.8rem;
      }

      h2 {
        font-size: 1.6rem;
        margin-bottom: 25px;
      }

      input, button {
        padding: 14px 18px;
        font-size: 15px;
      }

      .logo-container {
        font-size: 2.5rem;
        bottom: 30px;
      }
    }

    @media (max-width: 480px) {
      .floating-logo {
        font-size: 1.8rem;
        top: -50px;
        letter-spacing: 1px;
      }

      .login-container {
        margin: 15px;
        margin-top: 70px;
        padding: 25px 20px;
      }

      .language-menu {
        top: 10px;
        right: 10px;
      }

      .language-menu button {
        padding: 5px 6px;
        font-size: 0.75rem;
        min-width: 60px;
        gap: 5px;
      }

      .language-menu ul {
        width: 85px;
        top: 35px;
      }

      .language-menu ul li {
        padding: 8px 10px;
        font-size: 0.75rem;
        gap: 6px;
      }

      h2 {
        font-size: 1.4rem;
      }

      .logo-container {
        font-size: 2rem;
        bottom: 20px;
      }
    }
  </style>
</head>

<body>
  <div class="login-container">
    <!-- Logo flotante ArbitraX -->
    <div class="floating-logo">ArbitraX</div>
    <!-- Menú de idioma -->
    <div class="language-menu">
      <button onclick="toggleLangMenu()" id="currentLang">
        <img src="https://flagcdn.com/es.svg" width="20" /> ESP
      </button>
      <ul id="langOptions">
        <li onclick="setLang('es')"><img src="https://flagcdn.com/es.svg" width="20" /> ESP</li>
        <li onclick="setLang('en')"><img src="https://flagcdn.com/gb.svg" width="20" /> ENG</li>
        <li onclick="setLang('pt')"><img src="https://flagcdn.com/br.svg" width="20" /> POR</li>
      </ul>
    </div>

    <!-- Mensajes de estado -->
    <div id="messageContainer"></div>

    <!-- Login -->
    <div id="loginForm">
      <h2 id="loginTitle">
        <i class="fas fa-sign-in-alt"></i>
        Iniciar Sesión
      </h2>
      <input type="email" id="loginEmail" placeholder="Correo electrónico" />
      <input type="password" id="loginPass" placeholder="Contraseña" />
      <button onclick="login()" id="loginBtn">
        <i class="fas fa-arrow-right"></i>
        Entrar
      </button>
      <div class="form-switch">
        <span id="noAccount">¿No tienes cuenta?</span>
        <a onclick="showForm('registerForm')" id="registerLink">
          <i class="fas fa-user-plus"></i>
          Registrarse
        </a><br>
        <a onclick="showForm('recoverForm')" id="forgotPass">
          <i class="fas fa-key"></i>
          ¿Olvidaste tu contraseña?
        </a>
      </div>
    </div>

    <!-- Registro -->
    <div id="registerForm" class="hidden">
      <h2 id="registerTitle">
        <i class="fas fa-user-plus"></i>
        Registrarse
      </h2>
      <input type="email" id="regEmail" placeholder="Correo electrónico" />
      <input type="password" id="regPass" placeholder="Contraseña" />
      <input type="password" id="regRepeat" placeholder="Repetir contraseña" />
      <button onclick="register()" id="createBtn">
        <i class="fas fa-check"></i>
        Crear cuenta
      </button>
      <div class="form-switch">
        <a onclick="showForm('loginForm')" id="backLogin">
          <i class="fas fa-arrow-left"></i>
          Volver al inicio
        </a>
      </div>
    </div>

    <!-- Recuperar contraseña -->
    <div id="recoverForm" class="hidden">
      <h2 id="recoverTitle">
        <i class="fas fa-key"></i>
        Recuperar Contraseña
      </h2>
      <input type="email" id="recoveryEmail" placeholder="Correo electrónico" />
      <button onclick="recoverPassword()" id="sendBtn">
        <i class="fas fa-paper-plane"></i>
        Enviar
      </button>
      <div class="form-switch">
        <a onclick="showForm('loginForm')" id="backLogin2">
          <i class="fas fa-arrow-left"></i>
          Volver al inicio
        </a>
      </div>
    </div>
  </div>

  <!-- Logo ArbitraX -->
  <div class="logo-container">ArbitraX</div>

<script>
    const SUPABASE_URL = 'https://ovulezkcxwrjvyxlxsdv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92dWxlemtjeHdyanZ5eGx4c2R2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNzY5OTksImV4cCI6MjA2NDY1Mjk5OX0.ac82tkUR7AT0QVsuzuAGA8SXLkgnM9OX62meYNGnToI';
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Manejar parámetros de referido
    const urlParams = new URLSearchParams(window.location.search);
    const ref = urlParams.get("ref");
    if (ref) localStorage.setItem("referido_por", ref);

    // Funciones de UI
    function showForm(id) {
      ["loginForm", "registerForm", "recoverForm"].forEach(f => {
        document.getElementById(f).classList.add("hidden");
      });
      document.getElementById(id).classList.remove("hidden");
      hideMessage();
    }

    function showMessage(text, type = 'success') {
      const container = document.getElementById('messageContainer');
      container.innerHTML = `<div class="message ${type}">${text}</div>`;
      setTimeout(() => {
        container.querySelector('.message').classList.add('show');
      }, 100);
      
      // Auto-hide después de 5 segundos
      setTimeout(hideMessage, 5000);
    }

    function hideMessage() {
      const container = document.getElementById('messageContainer');
      const message = container.querySelector('.message');
      if (message) {
        message.classList.remove('show');
        setTimeout(() => container.innerHTML = '', 300);
      }
    }

    function setLoading(formId, loading) {
      const form = document.getElementById(formId);
      if (loading) {
        form.classList.add('loading');
      } else {
        form.classList.remove('loading');
      }
    }

    // FUNCIÓN REGISTER CORREGIDA - SIN VERIFICACIONES PREMATURAS
    async function register() {
      const email = document.getElementById("regEmail").value.trim();
      const pass1 = document.getElementById("regPass").value;
      const pass2 = document.getElementById("regRepeat").value;

      // Validaciones básicas
      if (!email || !pass1 || !pass2) {
        showMessage("Completa todos los campos", 'error');
        return;
      }

      if (pass1 !== pass2) {
        showMessage("Las contraseñas no coinciden", 'error');
        return;
      }

      if (pass1.length < 6) {
        showMessage("La contraseña debe tener al menos 6 caracteres", 'error');
        return;
      }

      setLoading('registerForm', true);

      try {
        // Solo hacer signUp - el trigger se encarga del resto
        const { data, error } = await client.auth.signUp({ 
          email, 
          password: pass1 
        });

        if (error) {
          throw new Error(error.message);
        }

        // Manejar referidos si existe
        const referidoPor = localStorage.getItem("referido_por");
        if (referidoPor && data?.user?.id) {
          try {
            await client.from("referidos").insert({
              usuario_id: data.user.id,
              referido_por: referidoPor,
              email: email,
              aprobado: false,
              fecha: new Date().toISOString()
            });
            localStorage.removeItem("referido_por");
          } catch (refError) {
            console.log("Error creando referido (no crítico):", refError);
          }
        }

        // Éxito - mostrar mensaje y cambiar a login
        showMessage("¡Cuenta creada exitosamente! Revisa tu correo para verificarla.", 'success');
        
        // Limpiar campos
        document.getElementById("regEmail").value = '';
        document.getElementById("regPass").value = '';
        document.getElementById("regRepeat").value = '';
        
        // Cambiar a login después de un breve delay
        setTimeout(() => {
          showForm("loginForm");
        }, 2000);

      } catch (error) {
        console.error("Error en registro:", error);
        let errorMessage = "Error al crear la cuenta";
        
        if (error.message.includes("already registered")) {
          errorMessage = "Este correo ya está registrado";
        } else if (error.message.includes("Password")) {
          errorMessage = "La contraseña no cumple los requisitos";
        } else if (error.message.includes("Email")) {
          errorMessage = "Correo electrónico inválido";
        }
        
        showMessage(errorMessage, 'error');
      } finally {
        setLoading('registerForm', false);
      }
    }

    async function login() {
      const email = document.getElementById("loginEmail").value.trim();
      const pass = document.getElementById("loginPass").value;

      if (!email || !pass) {
        showMessage("Completa todos los campos", 'error');
        return;
      }

      setLoading('loginForm', true);

      try {
        const { error } = await client.auth.signInWithPassword({ 
          email, 
          password: pass 
        });
        
        if (error) {
          throw new Error(error.message);
        }

        // Éxito
        showMessage("¡Bienvenido! Redirigiendo...", 'success');
        setTimeout(() => {
          window.location.href = "principal.html";
        }, 1500);

      } catch (error) {
        console.error("Error en login:", error);
        let errorMessage = "Error al iniciar sesión";
        
        if (error.message.includes("Invalid")) {
          errorMessage = "Correo o contraseña incorrectos";
        } else if (error.message.includes("Email not confirmed")) {
          errorMessage = "Confirma tu correo antes de iniciar sesión";
        }
        
        showMessage(errorMessage, 'error');
      } finally {
        setLoading('loginForm', false);
      }
    }

    async function recoverPassword() {
      const email = document.getElementById("recoveryEmail").value.trim();

      if (!email) {
        showMessage("Ingresa tu correo electrónico", 'error');
        return;
      }

      setLoading('recoverForm', true);

      try {
        const { error } = await client.auth.resetPasswordForEmail(email, {
          redirectTo: window.location.origin + '/reset.html'
        });
        
        if (error) {
          throw new Error(error.message);
        }

        showMessage("Correo de recuperación enviado. Revisa tu bandeja de entrada.", 'success');
        document.getElementById("recoveryEmail").value = '';
        
        setTimeout(() => {
          showForm("loginForm");
        }, 2000);

      } catch (error) {
        console.error("Error en recuperación:", error);
        showMessage("Error al enviar el correo de recuperación", 'error');
      } finally {
        setLoading('recoverForm', false);
      }
    }

    // Traducciones
    const translations = {
      es: {
        loginTitle: "Iniciar Sesión", registerTitle: "Registrarse", recoverTitle: "Recuperar Contraseña",
        loginBtn: "Entrar", createBtn: "Crear cuenta", sendBtn: "Enviar",
        noAccount: "¿No tienes cuenta?", registerLink: "Registrarse", forgotPass: "¿Olvidaste tu contraseña?",
        backLogin: "Volver al inicio", backLogin2: "Volver al inicio"
      },
      en: {
        loginTitle: "Login", registerTitle: "Register", recoverTitle: "Reset Password",
        loginBtn: "Login", createBtn: "Create account", sendBtn: "Send",
        noAccount: "Don't have an account?", registerLink: "Register", forgotPass: "Forgot password?",
        backLogin: "Back to login", backLogin2: "Back to login"
      },
      pt: {
        loginTitle: "Entrar", registerTitle: "Registrar", recoverTitle: "Recuperar Senha",
        loginBtn: "Acessar", createBtn: "Criar conta", sendBtn: "Enviar",
        noAccount: "Não tem uma conta?", registerLink: "Registrar-se", forgotPass: "Esqueceu a senha?",
        backLogin: "Voltar", backLogin2: "Voltar"
      }
    };

    function toggleLangMenu() {
      const menu = document.getElementById("langOptions");
      menu.style.display = menu.style.display === "block" ? "none" : "block";
    }

    function setLang(lang) {
      const t = translations[lang];
      document.getElementById("loginTitle").innerHTML = `<i class="fas fa-sign-in-alt"></i> ${t.loginTitle}`;
      document.getElementById("registerTitle").innerHTML = `<i class="fas fa-user-plus"></i> ${t.registerTitle}`;
      document.getElementById("recoverTitle").innerHTML = `<i class="fas fa-key"></i> ${t.recoverTitle}`;
      document.getElementById("loginBtn").innerHTML = `<i class="fas fa-arrow-right"></i> ${t.loginBtn}`;
      document.getElementById("createBtn").innerHTML = `<i class="fas fa-check"></i> ${t.createBtn}`;
      document.getElementById("sendBtn").innerHTML = `<i class="fas fa-paper-plane"></i> ${t.sendBtn}`;
      document.getElementById("noAccount").innerText = t.noAccount;
      document.getElementById("registerLink").innerHTML = `<i class="fas fa-user-plus"></i> ${t.registerLink}`;
      document.getElementById("forgotPass").innerHTML = `<i class="fas fa-key"></i> ${t.forgotPass}`;
      document.getElementById("backLogin").innerHTML = `<i class="fas fa-arrow-left"></i> ${t.backLogin}`;
      document.getElementById("backLogin2").innerHTML = `<i class="fas fa-arrow-left"></i> ${t.backLogin2}`;

      const flags = { es: "es", en: "gb", pt: "br" };
      const names = { es: "ESP", en: "ENG", pt: "POR" };
      document.getElementById("currentLang").innerHTML =
        `<img src="https://flagcdn.com/${flags[lang]}.svg" width="20" /> ${names[lang]}`;
      document.getElementById("langOptions").style.display = "none";
    }

    // Cerrar menú de idioma al hacer clic fuera
    document.addEventListener('click', function(event) {
      const langMenu = document.querySelector('.language-menu');
      const langOptions = document.getElementById('langOptions');
      
      if (!langMenu.contains(event.target)) {
        langOptions.style.display = 'none';
      }
    });

    // Verificar si ya hay sesión activa
    client.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session) {
        // Si ya está logueado, redirigir
        window.location.href = 'principal.html';
      }
    });
  </script>
</body>
</html>
