<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Caja Misteriosa</title>
  <link rel="icon" href="favicon.png" type="image/png" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-image: url('fondodepantallaprincipal1.jpeg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: white;
      display: flex;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Efectos de fondo m√°gicos */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(0, 168, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(255, 255, 255, 0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: 1;
    }

    .menu-toggle {
      position: fixed;
      top: 15px;
      left: 15px;
      font-size: 24px;
      cursor: pointer;
      z-index: 1001;
      background-color: rgba(0, 0, 0, 0.6);
      padding: 10px 15px;
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    .menu-toggle:hover {
      background-color: rgba(0, 168, 255, 0.6);
      transform: scale(1.1);
    }

    .sidebar {
      width: 230px;
      background-color: rgba(0, 0, 0, 0.85);
      height: 100vh;
      padding-top: 60px;
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }

    .sidebar.active {
      transform: translateX(0%);
    }

    .sidebar button {
      background: none;
      border: none;
      color: white;
      font-size: 15px;
      padding: 12px 20px;
      text-align: left;
      cursor: pointer;
      width: 100%;
      display: flex;
      align-items: center;
      transition: all 0.3s ease;
    }

    .sidebar button:hover {
      background-color: rgba(255, 255, 255, 0.1);
      transform: translateX(5px);
    }

    .sidebar button.active {
      background-color: rgba(0, 168, 255, 0.3);
      border-left: 3px solid #00a8ff;
    }

    .sidebar button i {
      margin-right: 12px;
      width: 20px;
      text-align: center;
    }

    .content {
      flex: 1;
      padding: 30px;
      margin-left: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      z-index: 2;
    }

    .mistery-container {
      background: rgba(0, 0, 0, 0.7);
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      max-width: 600px;
      width: 100%;
      box-shadow: 
        0 0 30px rgba(0, 168, 255, 0.3),
        0 0 60px rgba(255, 215, 0, 0.2),
        inset 0 1px 20px rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
    }

    .mistery-container::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255, 215, 0, 0.05), transparent);
      animation: containerShine 6s ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes containerShine {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 2.5rem;
      background: linear-gradient(135deg, #FFD700, #FFA500, #00a8ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
      animation: titleGlow 3s ease-in-out infinite alternate;
      font-weight: bold;
      letter-spacing: 2px;
      position: relative;
      z-index: 10;
    }

    @keyframes titleGlow {
      0% { filter: brightness(1); }
      100% { filter: brightness(1.3); }
    }

    .description {
      margin-bottom: 30px;
      font-size: 1.1rem;
      color: rgba(255, 255, 255, 0.9);
      line-height: 1.6;
      position: relative;
      z-index: 10;
    }

    .info-bar {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 30px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      position: relative;
      z-index: 10;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 120px;
    }

    .info-label {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 5px;
    }

    .info-value {
      font-size: 1.2rem;
      font-weight: bold;
      color: #FFD700;
    }

    /* ‚úÖ Indicador de stock disponible */
    .stock-indicator {
      background: rgba(0, 195, 255, 0.2);
      border: 1px solid rgba(0, 195, 255, 0.4);
      padding: 10px 15px;
      border-radius: 20px;
      margin-bottom: 20px;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .stock-indicator.low {
      background: rgba(255, 193, 7, 0.2);
      border-color: rgba(255, 193, 7, 0.4);
      color: #ffc107;
    }

    .stock-indicator.critical {
      background: rgba(220, 53, 69, 0.2);
      border-color: rgba(220, 53, 69, 0.4);
      color: #dc3545;
    }

    .treasure-chest-container {
      perspective: 1000px;
      width: 300px;
      margin: 0 auto 30px;
      height: 250px;
      position: relative;
    }

    .treasure-chest {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .treasure-chest:hover:not(.opening) {
      transform: translateY(-10px) rotateX(5deg);
      filter: drop-shadow(0 20px 40px rgba(255, 215, 0, 0.3));
    }

    .chest-base {
      width: 100%;
      height: 160px;
      background: linear-gradient(145deg, #8B4513, #A0522D, #CD853F);
      border-radius: 0 0 25px 25px;
      position: absolute;
      bottom: 0;
      box-shadow: 
        0 15px 35px rgba(0,0,0,0.4),
        inset 0 -8px 20px rgba(139, 69, 19, 0.8),
        inset 0 8px 20px rgba(205, 133, 63, 0.6);
      border: 3px solid #654321;
    }

    .chest-lid {
      width: 100%;
      height: 100px;
      background: linear-gradient(145deg, #A0522D, #CD853F, #DEB887);
      border-radius: 25px 25px 0 0;
      position: absolute;
      top: 0;
      left: 0;
      box-shadow: 
        0 -8px 25px rgba(0,0,0,0.3),
        inset 0 8px 20px rgba(222, 184, 135, 0.8),
        inset 0 -8px 20px rgba(160, 82, 45, 0.6);
      border: 3px solid #654321;
      transform-origin: bottom;
      transition: transform 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 5;
    }

    .chest-lid.open {
      transform: rotateX(-130deg);
    }

    .chest-lock {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 60px;
      background: linear-gradient(145deg, #FFD700, #FFA500);
      border-radius: 8px;
      box-shadow: 
        0 8px 20px rgba(255, 215, 0, 0.4),
        inset 0 3px 15px rgba(255, 255, 255, 0.3);
      border: 2px solid #DAA520;
      transition: all 0.5s ease;
    }

    .chest-lock::before {
      content: '';
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 30px;
      height: 30px;
      border: 5px solid #FFD700;
      border-radius: 50%;
      border-bottom: none;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
    }

    .chest-lock::after {
      content: 'üîê';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5rem;
      text-shadow: 0 0 10px rgba(0,0,0,0.5);
    }

    .chest-bands {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
    }

    .band {
      position: absolute;
      width: 100%;
      height: 12px;
      background: linear-gradient(90deg, #FFD700, #FFA500, #FFD700);
      box-shadow: 
        0 3px 12px rgba(255, 215, 0, 0.4),
        inset 0 2px 6px rgba(255, 255, 255, 0.3);
      border: 1px solid #DAA520;
    }

    .band:first-child {
      top: 40px;
    }

    .band:last-child {
      bottom: 40px;
    }

    .magical-aura {
      position: absolute;
      top: -30px;
      left: -30px;
      width: calc(100% + 60px);
      height: calc(100% + 60px);
      border-radius: 40px;
      background: radial-gradient(circle, transparent 60%, rgba(255, 215, 0, 0.1) 70%, transparent 80%);
      animation: auraGlow 4s ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes auraGlow {
      0%, 100% { 
        opacity: 0.4;
        transform: scale(1);
      }
      50% { 
        opacity: 0.8;
        transform: scale(1.1);
      }
    }

    .treasure-chest.opening {
      animation: chestShake 1s ease-in-out;
    }

    @keyframes chestShake {
      0%, 100% { transform: translateX(0) translateY(0) rotateZ(0deg); }
      10% { transform: translateX(-8px) translateY(-3px) rotateZ(-2deg); }
      20% { transform: translateX(8px) translateY(-3px) rotateZ(2deg); }
      30% { transform: translateX(-12px) translateY(-6px) rotateZ(-3deg); }
      40% { transform: translateX(12px) translateY(-6px) rotateZ(3deg); }
      50% { transform: translateX(-15px) translateY(-9px) rotateZ(-3deg); }
      60% { transform: translateX(15px) translateY(-9px) rotateZ(3deg); }
      70% { transform: translateX(-8px) translateY(-6px) rotateZ(-2deg); }
      80% { transform: translateX(8px) translateY(-3px) rotateZ(2deg); }
      90% { transform: translateX(-3px) translateY(-1px) rotateZ(-1deg); }
    }

    .light-explosion {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      pointer-events: none;
      z-index: 20;
    }

    .light-explosion.active {
      opacity: 1;
      animation: lightBurst 2.5s ease-out;
    }

    @keyframes lightBurst {
      0% { 
        opacity: 0;
        transform: scale(0.3);
      }
      30% { 
        opacity: 1;
        transform: scale(1);
      }
      100% { 
        opacity: 0.6;
        transform: scale(1.5);
      }
    }

    .light-ray {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 6px;
      height: 300px;
      background: linear-gradient(to top, transparent, #FFD700, #FFA500, transparent);
      transform-origin: bottom;
      border-radius: 3px;
      box-shadow: 0 0 20px #FFD700;
    }

    .open-button {
      background: linear-gradient(135deg, #00a8ff, #0078cc);
      color: white;
      padding: 18px 35px;
      border: none;
      border-radius: 50px;
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 
        0 8px 25px rgba(0, 168, 255, 0.4),
        inset 0 2px 10px rgba(255, 255, 255, 0.2);
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
      overflow: hidden;
      z-index: 10;
    }

    .open-button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transform: translateY(-50%);
      transition: left 0.6s ease;
    }

    .open-button:hover::before {
      left: 100%;
    }

    .open-button:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 
        0 12px 35px rgba(0, 168, 255, 0.6),
        inset 0 2px 15px rgba(255, 255, 255, 0.3);
    }

    .open-button:disabled {
      cursor: not-allowed;
      transform: none;
    }

    .open-button.no-stock {
      background: linear-gradient(135deg, #dc3545, #c82333);
      cursor: not-allowed;
    }

    .open-button.no-stock:hover {
      transform: none;
      box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
    }

.prize-reveal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      visibility: hidden;
      z-index: 2000;
      transition: all 0.5s ease;
      backdrop-filter: blur(10px);
    }

    .prize-reveal.show {
      opacity: 1;
      visibility: visible;
    }

    .prize-container {
      background: linear-gradient(135deg, #fff, #f8f9fa);
      padding: 50px;
      border-radius: 30px;
      box-shadow: 
        0 30px 80px rgba(0,0,0,0.5),
        0 0 150px rgba(255, 215, 0, 0.3);
      text-align: center;
      max-width: 450px;
      transform: scale(0.3) rotateY(180deg);
      transition: transform 1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 3px solid #FFD700;
      position: relative;
      overflow: hidden;
    }

    .prize-reveal.show .prize-container {
      transform: scale(1) rotateY(0deg);
    }

    .prize-container::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,215,0,0.1), transparent);
      animation: prizeShine 4s ease-in-out infinite;
    }

    @keyframes prizeShine {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .prize-icon {
      font-size: 6rem;
      margin-bottom: 25px;
      display: block;
      animation: bounce 2s ease-in-out infinite;
      text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
      position: relative;
      z-index: 10;
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-25px); }
      60% { transform: translateY(-15px); }
    }

    .prize-title {
      font-size: 1.8rem;
      color: #333;
      margin-bottom: 20px;
      font-weight: bold;
      background: linear-gradient(135deg, #FFD700, #FFA500);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      position: relative;
      z-index: 10;
    }

    .prize-description {
      color: #666;
      font-size: 1.1rem;
      margin-bottom: 35px;
      line-height: 1.6;
      position: relative;
      z-index: 10;
    }

    .close-btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 30px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.1rem;
      transition: all 0.3s ease;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      position: relative;
      z-index: 10;
    }

    .close-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(102, 126, 234, 0.6);
    }

    .particles-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1500;
    }

    .particle {
      position: absolute;
      border-radius: 50%;
      pointer-events: none;
    }

    .floating-coins {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 15;
    }

    .coin {
      position: absolute;
      font-size: 2rem;
      animation: floatUp 4s ease-out infinite;
      opacity: 0;
    }

    @keyframes floatUp {
      0% { 
        opacity: 0;
        transform: translateY(50px) rotate(0deg) scale(0.3);
      }
      15% { 
        opacity: 1;
        transform: translateY(0px) rotate(180deg) scale(1);
      }
      85% { 
        opacity: 1;
        transform: translateY(-150px) rotate(540deg) scale(1);
      }
      100% { 
        opacity: 0;
        transform: translateY(-300px) rotate(720deg) scale(0.3);
      }
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      background: rgba(220, 53, 69, 0.2);
      border: 1px solid #dc3545;
      color: #dc3545;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
      animation: shake 0.6s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    /* ‚úÖ Estilos para mensajes de stock */
    .stock-warning {
      background: rgba(255, 193, 7, 0.2);
      border: 2px solid #ffc107;
      color: #ffc107;
      padding: 15px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: bold;
      animation: pulse 2s infinite;
    }

    .stock-critical {
      background: rgba(220, 53, 69, 0.2);
      border: 2px solid #dc3545;
      color: #dc3545;
      padding: 15px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: bold;
      animation: pulse 2s infinite;
    }

    .success-message {
      background: rgba(40, 167, 69, 0.2);
      border: 2px solid #28a745;
      color: #28a745;
      padding: 15px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
      animation: successPulse 0.8s ease-out;
    }

    @keyframes successPulse {
      0% { transform: scale(0.9); opacity: 0; }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); opacity: 1; }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    @media (max-width: 768px) {
      .content {
        padding: 20px;
      }
      
      .mistery-container {
        padding: 25px;
      }
      
      .treasure-chest-container {
        width: 250px;
        height: 200px;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      .info-bar {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="menu-toggle" onclick="toggleSidebar()">‚ò∞</div>

  <div class="sidebar" id="sidebar">
    <button onclick="window.location.href='principal.html#welcome'"><i class="fas fa-home"></i> Inicio</button>
    <button onclick="window.location.href='principal.html#perfil'"><i class="fas fa-user"></i> Perfil</button>
    <button onclick="window.location.href='inversion.html'"><i class="fas fa-chart-line"></i> Nivel de inversi√≥n</button>
    <button onclick="window.location.href='deposito.html'"><i class="fas fa-wallet"></i> Dep√≥sito</button>
    <button onclick="window.location.href='retiro.html'"><i class="fas fa-hand-holding-usd"></i> Retiro</button>
    <button onclick="window.location.href='referidos.html'"><i class="fas fa-users"></i> Programa de referidos</button>
    <button onclick="window.location.href='trivia.html'"><i class="fas fa-question"></i> Trivia</button>
    <button onclick="window.location.href='minipool.html'"><i class="fas fa-coins"></i> Mini Pool</button>
    <button class="active"><i class="fas fa-box-open"></i> Mystery Box</button>
    <button onclick="window.location.href='sorteo.html'"><i class="fas fa-gift"></i> Sorteo</button>
    <button onclick="window.location.href='preguntasfrecuentes.html'"><i class="fas fa-question-circle"></i> Preguntas frecuentes</button>
    <button onclick="window.location.href='terminosycondiciones.html'"><i class="fas fa-file-contract"></i> T√©rminos y condiciones</button>
    <button onclick="logout()"><i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n</button>
  </div>

  <div class="content" onclick="closeSidebar()">
    <div class="mistery-container">
      <h1 id="pageTitle">üéÅ Caja Misteriosa üéÅ</h1>
      <p class="description" id="pageDescription">¬°Abr√≠ tu cofre y descubr√≠ premios especiales! Pod√©s ganar entradas gratis, bonificaciones o premios en efectivo.</p>

      <!-- ‚úÖ Indicador de stock disponible -->
      <div class="stock-indicator" id="stockIndicator" style="display: none;">
        <i class="fas fa-info-circle"></i>
        <span id="stockText">Cargando disponibilidad...</span>
      </div>

      <div class="error-message" id="errorMessage"></div>

      <!-- ‚úÖ Mensajes de stock -->
      <div id="stockWarnings"></div>

      <!-- Informaci√≥n de la caja -->
      <div class="info-bar" id="infoBar">
        <div class="info-item">
          <div class="info-label">üí∞ Costo</div>
          <div class="info-value" id="boxCost">Cargando...</div>
        </div>
        <div class="info-item">
          <div class="info-label">üéÅ Premios Disponibles</div>
          <div class="info-value" id="totalAvailable">Verificando...</div>
        </div>
        <div class="info-item">
          <div class="info-label">üíµ Tu Saldo</div>
          <div class="info-value" id="userBalance">Cargando...</div>
        </div>
      </div>

      <div class="treasure-chest-container">
        <div class="treasure-chest" id="treasureChest">
          <div class="magical-aura"></div>
          <div class="light-explosion" id="lightExplosion"></div>
          <div class="floating-coins" id="floatingCoins"></div>
          
          <div class="chest-base">
            <div class="chest-bands">
              <div class="band"></div>
              <div class="band"></div>
            </div>
            <div class="chest-lock" id="chestLock"></div>
          </div>
          
          <div class="chest-lid" id="chestLid"></div>
        </div>
      </div>

      <button class="open-button" id="openButton" onclick="abrirCaja()">
        <i class="fas fa-key"></i> <span id="buttonText">Cargando...</span>
      </button>
    </div>
  </div>

  <div class="prize-reveal" id="prizeReveal">
    <div class="prize-container">
      <span class="prize-icon" id="prizeIcon">üéâ</span>
      <div class="prize-title" id="prizeTitle">¬°Felicitaciones!</div>
      <div class="prize-description" id="prizeDescription">Has ganado un premio incre√≠ble</div>
      <button class="close-btn" onclick="resetChest()">Cerrar</button>
    </div>
  </div>

  <div class="particles-container" id="particlesContainer"></div>

</body>
</html>

<script>
  // ‚úÖ CONFIGURACI√ìN IGUAL A TRIVIA - CORREGIDA
  const supabaseUrl = "https://ovulezkcxwrjvyxlxsdv.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92dWxlemtjeHdyanZ5eGx4c2R2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNzY5OTksImV4cCI6MjA2NDY1Mjk5OX0.ac82tkUR7AT0QVsuzuAGA8SXLkgnM9OX62meYNGnToI";
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  // Variables globales
  let userBalance = 0;
  let isOpening = false;
  let usuarioActual = null;

  // ‚úÖ Configuraci√≥n din√°mica conectada con admin
  let mysteryBoxConfig = {
    cost: 5000,
    cash_remaining: 0,
    cash_amount: 1500,
    trivia_remaining: 0,
    minipool_remaining: 0,
    empty_remaining: 0,
    total_available: 0
  };

  // ‚úÖ FUNCI√ìN: Cargar configuraci√≥n completa desde admin
  async function cargarConfiguracionMysteryBox() {
    try {
      console.log('üîÑ Cargando configuraci√≥n de Mystery Box desde admin...');
      
      const { data, error } = await supabaseClient
        .from('mystery_box_config')
        .select('*')
        .eq('is_active', true)
        .order('created_at', { ascending: false })
        .limit(1)
        .maybeSingle();

      if (error) {
        console.error('Error cargando configuraci√≥n:', error);
        mostrarError('‚ùå Error al cargar configuraci√≥n del administrador.');
        return false;
      }

      if (data) {
        mysteryBoxConfig = {
          cost: data.box_cost || 5000,
          cash_remaining: data.cash_remaining || 0,
          cash_amount: data.cash_amount || 1500,
          trivia_remaining: data.trivia_remaining || 0,
          minipool_remaining: data.minipool_remaining || 0,
          empty_remaining: data.empty_remaining || 0,
          total_available: (data.cash_remaining || 0) + (data.trivia_remaining || 0) + (data.minipool_remaining || 0) + (data.empty_remaining || 0)
        };
        
        console.log('‚úÖ Configuraci√≥n cargada:', {
          costo: mysteryBoxConfig.cost,
          premios_disponibles: mysteryBoxConfig.total_available,
          efectivo_disponible: mysteryBoxConfig.cash_remaining,
          monto_efectivo: mysteryBoxConfig.cash_amount
        });
        
        updateUI();
        updateStockIndicators();
        return true;
      } else {
        console.warn('‚ö†Ô∏è No se encontr√≥ configuraci√≥n activa');
        mostrarError('‚ö†Ô∏è No hay configuraci√≥n de Mystery Box disponible en el administrador.');
        return false;
      }
      
    } catch (error) {
      console.error('üí• Error cargando configuraci√≥n:', error);
      mostrarError('‚ùå Error de conexi√≥n al cargar configuraci√≥n.');
      return false;
    }
  }

  // ‚úÖ FUNCI√ìN: Actualizar indicadores de stock
  function updateStockIndicators() {
    const stockIndicator = document.getElementById('stockIndicator');
    const stockText = document.getElementById('stockText');
    const stockWarnings = document.getElementById('stockWarnings');
    
    const totalPremios = mysteryBoxConfig.total_available;
    
    if (totalPremios <= 0) {
      stockIndicator.className = 'stock-indicator critical';
      stockIndicator.style.display = 'inline-flex';
      stockText.textContent = 'üö® ¬°Sin premios disponibles!';
      
      stockWarnings.innerHTML = `
        <div class="stock-critical">
          <i class="fas fa-exclamation-triangle"></i>
          ¬°AGOTADO! No hay premios disponibles en este momento
        </div>
      `;
    } else if (totalPremios <= 5) {
      stockIndicator.className = 'stock-indicator low';
      stockIndicator.style.display = 'inline-flex';
      stockText.textContent = `‚ö†Ô∏è Solo quedan ${totalPremios} premios`;
      
      stockWarnings.innerHTML = `
        <div class="stock-warning">
          <i class="fas fa-exclamation-triangle"></i>
          ¬°√öLTIMOS PREMIOS! Solo quedan ${totalPremios} premios disponibles
        </div>
      `;
    } else {
      stockIndicator.className = 'stock-indicator';
      stockIndicator.style.display = 'inline-flex';
      stockText.textContent = `‚úÖ ${totalPremios} premios disponibles`;
      stockWarnings.innerHTML = '';
    }
    
    document.getElementById('totalAvailable').textContent = `${totalPremios} disponibles`;
  }

  // ‚úÖ FUNCI√ìN: Generar premio basado en inventario limitado
  function generateRandomPrizeFromInventory() {
    console.log('üé≤ Generando premio desde inventario:', mysteryBoxConfig);
    
    const availablePrizes = [];
    
    // Agregar premios disponibles seg√∫n stock
    for (let i = 0; i < mysteryBoxConfig.cash_remaining; i++) {
      availablePrizes.push({
        type: 'cash',
        icon: 'üí∞',
        title: '¬°Premio en Efectivo!',
        description: `Has ganado $${mysteryBoxConfig.cash_amount.toLocaleString()} ARS`,
        value: mysteryBoxConfig.cash_amount
      });
    }
    
    for (let i = 0; i < mysteryBoxConfig.trivia_remaining; i++) {
      availablePrizes.push({
        type: 'trivia_entry',
        icon: 'üéØ',
        title: '¬°Entrada Gratis!',
        description: 'Entrada gratis a Trivia',
        value: 0
      });
    }
    
    for (let i = 0; i < mysteryBoxConfig.minipool_remaining; i++) {
      availablePrizes.push({
        type: 'minipool_entry',
        icon: 'üèä‚Äç‚ôÇÔ∏è',
        title: '¬°Minipool Gratis!',
        description: 'Entrada gratis a Minipool',
        value: 0
      });
    }
    
    for (let i = 0; i < mysteryBoxConfig.empty_remaining; i++) {
      availablePrizes.push({
        type: 'empty',
        icon: 'üòî',
        title: 'Caja Vac√≠a',
        description: '¬°Mejor suerte la pr√≥xima vez!',
        value: 0
      });
    }
    
    if (availablePrizes.length === 0) {
      return {
        type: 'empty',
        icon: 'üòî',
        title: 'Sin Premios',
        description: 'No hay premios disponibles',
        value: 0
      };
    }
    
    // Seleccionar premio aleatorio del inventario
    const randomIndex = Math.floor(Math.random() * availablePrizes.length);
    const selectedPrize = availablePrizes[randomIndex];
    
    console.log('üéÅ Premio seleccionado:', selectedPrize);
    return selectedPrize;
  }

  // ‚úÖ FUNCI√ìN: Consumir premio del inventario
  async function consumirPremioDelInventario(prize) {
    try {
      console.log('üì¶ Consumiendo premio del inventario:', prize.type);
      
      let updateField = '';
      let newValue = 0;
      
      switch (prize.type) {
        case 'cash':
          updateField = 'cash_remaining';
          newValue = Math.max(0, mysteryBoxConfig.cash_remaining - 1);
          mysteryBoxConfig.cash_remaining = newValue;
          break;
        case 'trivia_entry':
          updateField = 'trivia_remaining';
          newValue = Math.max(0, mysteryBoxConfig.trivia_remaining - 1);
          mysteryBoxConfig.trivia_remaining = newValue;
          break;
        case 'minipool_entry':
          updateField = 'minipool_remaining';
          newValue = Math.max(0, mysteryBoxConfig.minipool_remaining - 1);
          mysteryBoxConfig.minipool_remaining = newValue;
          break;
        case 'empty':
          updateField = 'empty_remaining';
          newValue = Math.max(0, mysteryBoxConfig.empty_remaining - 1);
          mysteryBoxConfig.empty_remaining = newValue;
          break;
        default:
          console.warn('‚ö†Ô∏è Tipo de premio desconocido:', prize.type);
          return;
      }
      
      // Actualizar en la base de datos
      const { error } = await supabaseClient
        .from('mystery_box_config')
        .update({ [updateField]: newValue })
        .eq('is_active', true);

      if (error) {
        console.error('‚ùå Error actualizando inventario:', error);
        throw error;
      }
      
      // Actualizar total disponible
      mysteryBoxConfig.total_available = mysteryBoxConfig.cash_remaining + 
                                        mysteryBoxConfig.trivia_remaining + 
                                        mysteryBoxConfig.minipool_remaining + 
                                        mysteryBoxConfig.empty_remaining;
      
      console.log('‚úÖ Inventario actualizado:', {
        campo_actualizado: updateField,
        nuevo_valor: newValue,
        total_disponible: mysteryBoxConfig.total_available
      });
      
    } catch (error) {
      console.error('üí• Error consumiendo premio del inventario:', error);
      throw error;
    }
  }

  // ‚úÖ FUNCI√ìN: Verificar usuario - igual a Trivia
  async function verificarUsuario() {
    const { data: { user }, error } = await supabaseClient.auth.getUser();
    
    if (error || !user) {
      mostrarError('No est√°s autenticado. Por favor, inicia sesi√≥n.');
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 3000);
      return;
    }

    const { data: profile, error: profileError } = await supabaseClient
      .from('profiles')
      .select('*')
      .eq('id', user.id)
      .single();

    if (profileError || !profile) {
      mostrarError('Error al obtener datos del usuario.');
      return;
    }

    usuarioActual = {
      id: user.id,
      email: user.email,
      nombre: profile.username || profile.email || 'Usuario'
    };
  }

  // ‚úÖ FUNCI√ìN: Cargar saldo - igual a Trivia
  async function cargarSaldoUsuario() {
    try {
      const { data: balance, error } = await supabaseClient
        .from('balances')
        .select('saldo')
        .eq('usuario_id', usuarioActual.id)
        .maybeSingle();

      if (error) {
        console.error('Error al cargar saldo:', error);
        userBalance = 0;
      } else {
        userBalance = balance?.saldo || 0;
      }

      document.getElementById('userBalance').textContent = `$${userBalance.toLocaleString()}`;
      
    } catch (error) {
      console.error('Error cargando saldo:', error);
      userBalance = 0;
      document.getElementById('userBalance').textContent = '$0';
    }
  }

  // ‚úÖ FUNCI√ìN: Descontar saldo - igual a Trivia
  async function descontarSaldo(precio) {
    try {
      const nuevoSaldo = userBalance - precio;
      
      const { error } = await supabaseClient
        .from('balances')
        .update({ saldo: nuevoSaldo })
        .eq('usuario_id', usuarioActual.id);

      if (error) {
        throw new Error('Error al descontar saldo: ' + error.message);
      }

      userBalance = nuevoSaldo;
      document.getElementById('userBalance').textContent = `$${userBalance.toLocaleString()}`;
      
      return true;
    } catch (error) {
      console.error('Error descontando saldo:', error);
      throw error;
    }
  }

  // ‚úÖ FUNCI√ìN: Agregar premio al saldo - igual a Trivia
  async function agregarPremioAlSaldo(premio) {
    try {
      const nuevoSaldo = userBalance + premio;
      
      const { error } = await supabaseClient
        .from('balances')
        .update({ saldo: nuevoSaldo })
        .eq('usuario_id', usuarioActual.id);

      if (error) {
        throw new Error('Error al agregar premio: ' + error.message);
      }

      userBalance = nuevoSaldo;
      document.getElementById('userBalance').textContent = `$${userBalance.toLocaleString()}`;
      
      return true;
    } catch (error) {
      console.error('Error agregando premio:', error);
      throw error;
    }
  }

  // Funci√≥n para formatear moneda
  function formatCurrency(amount) {
    return new Intl.NumberFormat('es-AR', {
      style: 'currency',
      currency: 'ARS',
      minimumFractionDigits: 0
    }).format(amount);
  }

  // Funci√≥n para mostrar errores
  function mostrarError(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    setTimeout(() => {
      errorDiv.style.display = 'none';
    }, 8000);
  }

  // Funci√≥n para mostrar mensajes de √©xito
  function mostrarExito(message) {
    const stockWarnings = document.getElementById('stockWarnings');
    const successDiv = document.createElement('div');
    successDiv.className = 'success-message';
    successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
    stockWarnings.appendChild(successDiv);
    
    setTimeout(() => {
      successDiv.remove();
    }, 5000);
  }

  // ‚úÖ FUNCI√ìN ACTUALIZAR UI - COMPLETAMENTE CORREGIDA
  function updateUI() {
    console.log('üîÑ Actualizando UI. Estado actual:', {
      saldo_usuario: userBalance,
      costo_caja: mysteryBoxConfig.cost,
      premios_disponibles: mysteryBoxConfig.total_available,
      esta_abriendo: isOpening
    });

    document.getElementById('boxCost').textContent = formatCurrency(mysteryBoxConfig.cost);
    document.getElementById('userBalance').textContent = formatCurrency(userBalance);
    
    const openButton = document.getElementById('openButton');
    
    // ‚úÖ CORRECCI√ìN: Resetear completamente el bot√≥n
    openButton.classList.remove('no-stock', 'loading');
    openButton.style.opacity = '1';
    openButton.disabled = false;
    
    // Verificar condiciones en orden correcto
    if (isOpening) {
      // Est√° procesando una compra
      openButton.disabled = true;
      openButton.innerHTML = '<div class="spinner"></div> Abriendo...';
      console.log('‚úÖ Bot√≥n: Abriendo...');
    } else if (mysteryBoxConfig.total_available <= 0) {
      // No hay premios
      openButton.disabled = true;
      openButton.classList.add('no-stock');
      openButton.innerHTML = '<i class="fas fa-times"></i> Sin Premios Disponibles';
      openButton.title = 'No hay premios disponibles';
      console.log('‚úÖ Bot√≥n: Sin premios disponibles');
    } else if (userBalance < mysteryBoxConfig.cost) {
      // Saldo insuficiente
      openButton.disabled = true;
      openButton.style.opacity = '0.7';
      openButton.innerHTML = `<i class="fas fa-wallet"></i> Saldo Insuficiente`;
      openButton.title = 'Saldo insuficiente';
      console.log('‚úÖ Bot√≥n: Saldo insuficiente');
    } else {
      // Todo OK - puede comprar
      openButton.disabled = false;
      openButton.innerHTML = `<i class="fas fa-key"></i> Abrir Caja (${formatCurrency(mysteryBoxConfig.cost)})`;
      openButton.title = '';
      console.log('‚úÖ Bot√≥n: Listo para comprar');
    }
  }

// ‚úÖ FUNCI√ìN: Registrar compra
  async function registerMysteryBoxPurchase() {
    try {
      const { data, error } = await supabaseClient
        .from('recompensas')
        .insert({
          usuario_id: usuarioActual.id,
          meta: null,
          fecha: new Date().toISOString(),
          monto: -mysteryBoxConfig.cost,
          moneda: 'ARS',
          aprobado: true,
          tipo: 'mysterybox_compra'
        })
        .select()
        .single();

      if (error) throw error;
      return data;

    } catch (error) {
      console.error('Error registrando compra:', error);
      throw error;
    }
  }

  // ‚úÖ FUNCI√ìN: Registrar premio
  async function registerPrizeWon(prize) {
    try {
      if (prize.value > 0 && prize.type === 'cash') {
        const { data, error } = await supabaseClient
          .from('recompensas')
          .insert({
            usuario_id: usuarioActual.id,
            meta: null,
            fecha: new Date().toISOString(),
            monto: prize.value,
            moneda: 'ARS',
            aprobado: true,
            tipo: 'mysterybox_cash'
          })
          .select()
          .single();

        if (error) throw error;
        return data;
      }

      if (prize.type === 'trivia_entry' || prize.type === 'minipool_entry') {
        const { data, error } = await supabaseClient
          .from('recompensas')
          .insert({
            usuario_id: usuarioActual.id,
            meta: null,
            fecha: new Date().toISOString(),
            monto: 0,
            moneda: 'ARS',
            aprobado: true,
            tipo: `mysterybox_${prize.type}`
          })
          .select()
          .single();

        if (error) throw error;
        return data;
      }

      return null;

    } catch (error) {
      console.error('Error registrando premio:', error);
      throw error;
    }
  }

  // Funci√≥n para crear explosi√≥n de luz
  function createLightExplosion() {
    const lightExplosion = document.getElementById('lightExplosion');
    lightExplosion.innerHTML = '';
    
    for (let i = 0; i < 16; i++) {
      const ray = document.createElement('div');
      ray.className = 'light-ray';
      ray.style.transform = `translate(-50%, -50%) rotate(${i * 22.5}deg)`;
      ray.style.animationDelay = `${i * 0.05}s`;
      lightExplosion.appendChild(ray);
    }
    
    lightExplosion.classList.add('active');
  }

  // Funci√≥n para crear explosi√≥n de part√≠culas
  function createParticleExplosion() {
    const container = document.getElementById('particlesContainer');
    container.innerHTML = '';
    
    const colors = ['#FFD700', '#FFA500', '#00a8ff', '#FF6347', '#32CD32', '#9370DB', '#FF1493'];
    
    for (let i = 0; i < 150; i++) {
      const particle = document.createElement('div');
      particle.className = 'particle';
      
      const color = colors[Math.floor(Math.random() * colors.length)];
      const size = Math.random() * 8 + 4;
      particle.style.backgroundColor = color;
      particle.style.width = size + 'px';
      particle.style.height = size + 'px';
      particle.style.boxShadow = `0 0 15px ${color}`;
      
      const startX = window.innerWidth / 2;
      const startY = window.innerHeight / 2;
      particle.style.left = startX + 'px';
      particle.style.top = startY + 'px';
      
      const angle = (i / 150) * Math.PI * 2;
      const velocity = 150 + Math.random() * 400;
      const gravity = 600;
      const life = 2500 + Math.random() * 2000;

      particle.animate([
        {
          transform: 'translate(0, 0) scale(0)',
          opacity: 1
        },
        {
          transform: `translate(${Math.cos(angle) * velocity * 0.4}px, ${Math.sin(angle) * velocity * 0.4 - gravity * 0.3}px) scale(1)`,
          opacity: 1,
          offset: 0.4
        },
        {
          transform: `translate(${Math.cos(angle) * velocity}px, ${Math.sin(angle) * velocity + gravity}px) scale(0.2)`,
          opacity: 0
        }
      ], {
        duration: life,
        easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
      });
      
      container.appendChild(particle);
    }
  }

  // Funci√≥n para crear monedas flotantes
  function createFloatingCoins() {
    const container = document.getElementById('floatingCoins');
    container.innerHTML = '';
    
    const coinEmojis = ['ü™ô', 'üí∞', 'üíé', '‚≠ê', '‚ú®', 'üéÅ'];
    
    for (let i = 0; i < 25; i++) {
      const coin = document.createElement('div');
      coin.className = 'coin';
      coin.textContent = coinEmojis[Math.floor(Math.random() * coinEmojis.length)];
      
      coin.style.left = Math.random() * 100 + '%';
      coin.style.animationDelay = Math.random() * 3 + 's';
      coin.style.animationDuration = (3 + Math.random() * 2) + 's';
      
      container.appendChild(coin);
    }
  }

  // ‚úÖ FUNCI√ìN PRINCIPAL ABRIR CAJA - COMPLETAMENTE CORREGIDA
  async function abrirCaja() {
    if (isOpening) {
      console.log('‚ö†Ô∏è Ya se est√° abriendo una caja, ignorando click');
      return;
    }
    
    try {
      console.log('üéÅ Iniciando apertura de caja...');
      
      // Verificar saldo actualizado
      await cargarSaldoUsuario();
      
      if (userBalance < mysteryBoxConfig.cost) {
        mostrarError('‚ùå Saldo insuficiente para abrir la caja');
        return;
      }
      
      if (mysteryBoxConfig.total_available <= 0) {
        mostrarError('‚ùå No hay premios disponibles en este momento');
        return;
      }

      // ‚úÖ CORRECCI√ìN: Marcar como procesando INMEDIATAMENTE
      isOpening = true;
      updateUI(); // Actualizar UI inmediatamente
      
      const chest = document.getElementById('treasureChest');
      const lid = document.getElementById('chestLid');
      const lock = document.getElementById('chestLock');
      const prizeReveal = document.getElementById('prizeReveal');
      
      console.log('üí∞ Registrando compra y descontando saldo...');
      await registerMysteryBoxPurchase();
      await descontarSaldo(mysteryBoxConfig.cost);
      
      console.log('üé≤ Generando premio desde inventario...');
      const prize = generateRandomPrizeFromInventory();
      
      console.log('üì¶ Consumiendo premio del inventario...');
      await consumirPremioDelInventario(prize);
      
      // Animaci√≥n de temblor
      chest.classList.add('opening');
      
      setTimeout(() => {
        // Ocultar el candado con animaci√≥n
        lock.style.opacity = '0';
        lock.style.transform = 'translateX(-50%) scale(0) rotate(180deg)';
        
        // Abrir la tapa del cofre
        lid.classList.add('open');
        
        // Crear efectos visuales
        createLightExplosion();
        createFloatingCoins();
        
        setTimeout(() => {
          createParticleExplosion();
        }, 800);
        
      }, 1000);
      
      console.log('üìù Registrando premio en historial...');
      await registerPrizeWon(prize);
      
      if (prize.value > 0 && prize.type === 'cash') {
        console.log('üíµ Agregando premio al saldo:', prize.value);
        await agregarPremioAlSaldo(prize.value);
        mostrarExito(`üéâ ¬°Ganaste ${formatCurrency(prize.value)}! Se agreg√≥ a tu saldo.`);
      }
      
      setTimeout(() => {
        // Mostrar premio
        document.getElementById('prizeIcon').textContent = prize.icon;
        document.getElementById('prizeTitle').textContent = prize.title;
        document.getElementById('prizeDescription').textContent = prize.description;
        
        prizeReveal.classList.add('show');
      }, 2800);
      
      // ‚úÖ CORRECCI√ìN: Actualizar configuraci√≥n despu√©s del premio
      setTimeout(async () => {
        await cargarConfiguracionMysteryBox();
        updateStockIndicators();
      }, 3000);
      
    } catch (error) {
      console.error('üí• Error abriendo caja:', error);
      mostrarError('‚ùå Error al abrir la caja: ' + error.message);
      
      // ‚úÖ CORRECCI√ìN: Resetear estado en caso de error
      isOpening = false;
      updateUI();
    }
  }

  // ‚úÖ FUNCI√ìN RESETEAR COFRE - COMPLETAMENTE CORREGIDA
  function resetChest() {
    console.log('üîÑ Reseteando cofre...');
    
    const chest = document.getElementById('treasureChest');
    const lid = document.getElementById('chestLid');
    const lock = document.getElementById('chestLock');
    const prizeReveal = document.getElementById('prizeReveal');
    const lightExplosion = document.getElementById('lightExplosion');
    const floatingCoins = document.getElementById('floatingCoins');
    const particlesContainer = document.getElementById('particlesContainer');
    
    // ‚úÖ CORRECCI√ìN: Resetear estado PRIMERO
    isOpening = false;
    console.log('‚úÖ Estado isOpening reseteado a:', isOpening);
    
    // Reset todas las animaciones
    chest.classList.remove('opening');
    lid.classList.remove('open');
    lightExplosion.classList.remove('active');
    prizeReveal.classList.remove('show');
    
    // Restaurar el candado
    lock.style.opacity = '1';
    lock.style.transform = 'translateX(-50%) scale(1) rotate(0deg)';
    
    // Limpiar efectos
    lightExplosion.innerHTML = '';
    floatingCoins.innerHTML = '';
    particlesContainer.innerHTML = '';
    
    // ‚úÖ CORRECCI√ìN: Actualizar UI despu√©s de resetear estado
    updateUI();
    
    // Recrear monedas flotantes
    setTimeout(() => {
      createFloatingCoins();
    }, 500);
    
    console.log('‚úÖ Cofre reseteado correctamente');
  }

  // Funciones del sidebar
  function toggleSidebar() {
    document.getElementById("sidebar").classList.toggle("active");
  }

  function closeSidebar() {
    document.getElementById("sidebar").classList.remove("active");
  }

  // Funci√≥n de logout
  async function logout() {
    await supabaseClient.auth.signOut();
    window.location.href = "index.html";
  }

  // ‚úÖ FUNCI√ìN INICIALIZAR - CORREGIDA
  async function initializePage() {
    try {
      console.log('üéÅ Iniciando Mystery Box con inventario limitado...');
      
      await verificarUsuario();
      console.log('‚úÖ Usuario autenticado:', usuarioActual.email);
      
      const configLoaded = await cargarConfiguracionMysteryBox();
      if (!configLoaded) {
        console.error('‚ùå No se pudo cargar configuraci√≥n del admin');
        return;
      }
      
      await cargarSaldoUsuario();
      console.log('üí∞ Saldo cargado:', userBalance);
      
      updateUI();
      updateStockIndicators();
      
      // Crear monedas flotantes iniciales
      createFloatingCoins();
      
      // Recrear monedas cada 8 segundos
      setInterval(() => {
        if (!isOpening) {
          createFloatingCoins();
        }
      }, 8000);
      
      // ‚úÖ CORRECCI√ìN: Recargar configuraci√≥n cada 15 segundos
      setInterval(async () => {
        if (!isOpening) {
          console.log('üîÑ Verificando cambios desde admin...');
          await cargarConfiguracionMysteryBox();
          updateStockIndicators();
          // ‚úÖ CORRECCI√ìN: Solo actualizar UI si no est√° procesando
          if (!isOpening) {
            updateUI();
          }
        }
      }, 15000);
      
      console.log('üéÅ Mystery Box inicializado correctamente');
      
    } catch (error) {
      console.error('üí• Error inicializando p√°gina:', error);
      mostrarError('‚ùå Error al cargar la p√°gina: ' + error.message);
    }
  }

  // ‚úÖ CORRECCI√ìN: Event listeners mejorados
  document.addEventListener('DOMContentLoaded', initializePage);
  
  // ‚úÖ CORRECCI√ìN: Solo un event listener para el cofre
  document.getElementById('treasureChest').addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    console.log('üñ±Ô∏è Click en cofre detectado');
    abrirCaja();
  });

  // ‚úÖ CORRECCI√ìN: Prevenir doble click en bot√≥n
  document.getElementById('openButton').addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    console.log('üñ±Ô∏è Click en bot√≥n detectado');
    if (!isOpening) {
      abrirCaja();
    } else {
      console.log('‚ö†Ô∏è Bot√≥n clickeado pero ya est√° procesando');
    }
  });

  console.log('üéÅ Mystery Box Usuario - Sistema con inventario limitado cargado');
  console.log('üîó Conectado con panel de administrador');
  console.log('üì¶ Funcionalidades habilitadas:');
  console.log('  - ‚úÖ Premios limitados por stock');
  console.log('  - ‚úÖ Lecturas din√°micas desde admin');
  console.log('  - ‚úÖ Consumo real de inventario');
  console.log('  - ‚úÖ Indicadores de stock en tiempo real');
  console.log('  - ‚úÖ Bot√≥n corregido sin doble procesamiento');
  console.log('  - ‚úÖ Event listeners optimizados');

</script>
</body>
</html>
