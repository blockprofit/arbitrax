<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Gestión de Sorteos</title>
  <link rel="icon" href="favicon.png" type="image/png" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-image: url('fondodepantallaprincipal1.jpeg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      min-height: 100vh;
      color: white;
      overflow-x: hidden;
      padding: 20px;
    }

    * {
      box-sizing: border-box;
    }

    .admin-header {
      text-align: center;
      margin-bottom: 40px;
      background: linear-gradient(135deg, 
        rgba(0, 0, 0, 0.8), 
        rgba(0, 195, 255, 0.1)
      );
      backdrop-filter: blur(20px);
      border: 2px solid rgba(0, 195, 255, 0.3);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
    }

    .admin-title {
      font-size: 2.5rem;
      font-weight: 900;
      background: linear-gradient(135deg, #00c3ff, #00ffcc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 30px rgba(0, 195, 255, 0.5);
      animation: glow 3s ease-in-out infinite alternate;
      margin-bottom: 15px;
    }

    @keyframes glow {
      from { filter: brightness(1) drop-shadow(0 0 20px rgba(0, 195, 255, 0.7)); }
      to { filter: brightness(1.2) drop-shadow(0 0 35px rgba(0, 255, 204, 0.9)); }
    }

    .admin-subtitle {
      color: rgba(255, 255, 255, 0.8);
      font-size: 1.1rem;
    }

    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    .admin-panel {
      background: linear-gradient(135deg, 
        rgba(0, 0, 0, 0.8), 
        rgba(0, 195, 255, 0.1)
      );
      backdrop-filter: blur(20px);
      border: 2px solid rgba(0, 195, 255, 0.3);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      position: relative;
      overflow: hidden;
    }

    .admin-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(0, 195, 255, 0.1), transparent);
      transition: left 0.6s ease;
      animation: sweep 4s ease-in-out infinite;
    }

    @keyframes sweep {
      0%, 100% { left: -100%; }
      50% { left: 100%; }
    }

    .panel-title {
      font-size: 1.5rem;
      font-weight: bold;
      color: #00c3ff;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
      z-index: 10;
    }

    .form-group {
      margin-bottom: 20px;
      position: relative;
      z-index: 10;
    }

    .form-label {
      display: block;
      color: #00ffcc;
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 1rem;
    }

    .form-input {
      width: 100%;
      padding: 12px 15px;
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid rgba(0, 195, 255, 0.3);
      border-radius: 10px;
      color: white;
      font-size: 1rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .form-input:focus {
      outline: none;
      border-color: #00c3ff;
      background: rgba(0, 195, 255, 0.1);
      box-shadow: 0 0 20px rgba(0, 195, 255, 0.3);
    }

    .form-textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px 15px;
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid rgba(0, 195, 255, 0.3);
      border-radius: 10px;
      color: white;
      font-size: 1rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      resize: vertical;
      font-family: 'Segoe UI', sans-serif;
    }

    .form-textarea:focus {
      outline: none;
      border-color: #00c3ff;
      background: rgba(0, 195, 255, 0.1);
      box-shadow: 0 0 20px rgba(0, 195, 255, 0.3);
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      z-index: 10;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.6s ease;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, #00c3ff, #00ffcc);
      color: black;
      box-shadow: 0 8px 20px rgba(0, 195, 255, 0.4);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #0099cc, #00cc99);
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(0, 195, 255, 0.6);
    }

    .btn-danger {
      background: linear-gradient(135deg, #dc3545, #c82333);
      color: white;
      box-shadow: 0 8px 20px rgba(220, 53, 69, 0.4);
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #c82333, #a71e2a);
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(220, 53, 69, 0.6);
    }

    .btn-warning {
      background: linear-gradient(135deg, #ffc107, #e0a800);
      color: black;
      box-shadow: 0 8px 20px rgba(255, 193, 7, 0.4);
    }

    .btn-warning:hover {
      background: linear-gradient(135deg, #e0a800, #c69500);
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(255, 193, 7, 0.6);
    }

    .status-card {
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid rgba(0, 195, 255, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
      position: relative;
      z-index: 10;
    }

    .status-title {
      color: #00ffcc;
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }

    .status-value {
      color: white;
      font-size: 1rem;
    }

    .participants-list {
      max-height: 300px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
      position: relative;
      z-index: 10;
    }

    .participants-list::-webkit-scrollbar {
      width: 6px;
    }

    .participants-list::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    .participants-list::-webkit-scrollbar-thumb {
      background: rgba(0, 195, 255, 0.5);
      border-radius: 3px;
    }

    .participant-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin: 5px 0;
      background: rgba(0, 195, 255, 0.1);
      border-radius: 8px;
      border-left: 4px solid #00c3ff;
    }

    .participant-email {
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
    }

    .participant-status {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .participant-status.califica {
      background: #28a745;
      color: white;
    }

    .participant-status.no-califica {
      background: #dc3545;
      color: white;
    }

.winners-section {
      background: rgba(0, 0, 0, 0.4);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      border: 2px solid #00ffcc;
      position: relative;
      z-index: 10;
    }

    .winner-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      margin: 8px 0;
      background: linear-gradient(90deg, rgba(0, 195, 255, 0.2), rgba(0, 255, 204, 0.1));
      border-radius: 8px;
      border-left: 4px solid #00ffcc;
    }

    .winner-email {
      font-family: 'Courier New', monospace;
      font-weight: bold;
    }

    .winner-prize {
      color: #00ffcc;
      font-weight: bold;
    }

    .alert {
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      border: 2px solid;
      backdrop-filter: blur(10px);
      position: relative;
      z-index: 10;
    }

    .alert-success {
      background: linear-gradient(135deg, rgba(40, 167, 69, 0.8), rgba(40, 167, 69, 0.6));
      border-color: #28a745;
      color: white;
    }

    .alert-error {
      background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(220, 53, 69, 0.6));
      border-color: #dc3545;
      color: white;
    }

    .alert-warning {
      background: linear-gradient(135deg, rgba(255, 193, 7, 0.8), rgba(255, 193, 7, 0.6));
      border-color: #ffc107;
      color: black;
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #00c3ff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .admin-container {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .admin-title {
        font-size: 2rem;
      }

      .admin-panel {
        padding: 20px;
      }
    }
  </style>
</head>

<body>

<div class="admin-header">
  <div class="admin-title">
    <i class="fas fa-crown"></i>
    PANEL ADMIN - SORTEOS
  </div>
  <div class="admin-subtitle">
    Gestiona sorteos, participantes y ganadores • Los premios se suman automáticamente al saldo
  </div>
</div>

<div class="admin-container">
  <!-- Panel de Configuración -->
  <div class="admin-panel">
    <div class="panel-title">
      <i class="fas fa-cog"></i>
      Configuración del Sorteo
    </div>

    <div id="alerts"></div>

    <form id="sorteoConfigForm">
      <div class="form-group">
        <label class="form-label">
          <i class="fas fa-calendar-alt"></i>
          Fecha del Sorteo
        </label>
        <input type="datetime-local" id="fechaSorteo" class="form-input" required>
      </div>

      <div class="form-group">
        <label class="form-label">
          <i class="fas fa-money-bill-wave"></i>
          Monto del Premio (ARS)
        </label>
        <input type="number" id="montoSorteo" class="form-input" min="1" step="1" placeholder="Ej: 100000" required>
      </div>

      <button type="submit" class="btn btn-primary" style="width: 100%;">
        <i class="fas fa-save"></i>
        Guardar Configuración
      </button>
    </form>

    <div class="status-card">
      <div class="status-title">Estado Actual del Sorteo</div>
      <div class="status-value" id="sorteoStatus">Cargando...</div>
    </div>
  </div>

  <!-- Panel de Participantes y Ganadores -->
  <div class="admin-panel">
    <div class="panel-title">
      <i class="fas fa-users"></i>
      Participantes y Ganadores
    </div>

    <div class="status-card">
      <div class="status-title">Estadísticas</div>
      <div class="status-value">
        <strong>Total participantes:</strong> <span id="totalParticipantes">0</span><br>
        <strong>Califican:</strong> <span id="participantesCalifican">0</span><br>
        <strong>No califican:</strong> <span id="participantesNoCalifican">0</span>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">
        <i class="fas fa-trophy"></i>
        Seleccionar Ganadores (emails separados por comas)
      </label>
      <textarea id="ganadoresEmails" class="form-textarea" 
                placeholder="usuario1@email.com, usuario2@email.com, usuario3@email.com"></textarea>
      <small style="color: #00ffcc; font-size: 0.9rem; margin-top: 5px; display: block;">
        💡 Los premios se dividirán entre los ganadores y se sumarán automáticamente a sus saldos
      </small>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
      <button onclick="procesarGanadores()" class="btn btn-primary">
        <i class="fas fa-crown"></i>
        Procesar Ganadores
      </button>
      <button onclick="limpiarGanadores()" class="btn btn-danger">
        <i class="fas fa-trash"></i>
        Limpiar Ganadores
      </button>
    </div>

    <button onclick="actualizarParticipacion()" class="btn btn-warning" style="width: 100%;">
      <i class="fas fa-sync"></i>
      Actualizar Participación
    </button>

    <!-- Lista de Participantes -->
    <div class="participants-list" id="participantsList">
      <div style="text-align: center; color: #666; padding: 20px;">
        <i class="fas fa-spinner fa-spin"></i> Cargando participantes...
      </div>
    </div>

    <!-- Sección de Ganadores -->
    <div class="winners-section">
      <div style="color: #00ffcc; font-weight: bold; margin-bottom: 15px;">
        <i class="fas fa-trophy"></i> Ganadores Actuales
      </div>
      <div id="winnersContainer">
        <div style="text-align: center; color: #666; padding: 20px;">
          No hay ganadores seleccionados
        </div>
      </div>
    </div>
  </div>
</div>

<script>

const SUPABASE_URL = 'https://ovulezkcxwrjvyxlxsdv.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92dWxlemtjeHdyanZ5eGx4c2R2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNzY5OTksImV4cCI6MjA2NDY1Mjk5OX0.ac82tkUR7AT0QVsuzuAGA8SXLkgnM9OX62meYNGnToI';
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentConfig = null;
  let participantesList = [];
  let ganadoresActuales = [];

  // Inicializar
  async function init() {
    console.log('🚀 Iniciando Panel Admin de Sorteos Integrado');
    await cargarConfiguracion();
    await cargarParticipantes();
    await cargarGanadores();
    
    // Actualizar cada 30 segundos
    setInterval(() => {
      cargarParticipantes();
      cargarGanadores();
    }, 30000);
  }

  // Cargar configuración actual
  async function cargarConfiguracion() {
    try {
      const { data, error } = await client
        .from('sorteo_config')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(1)
        .maybeSingle();

      if (error) throw error;

      if (data) {
        currentConfig = data;
        
        // Llenar formulario
        const fecha = new Date(data.fecha);
        document.getElementById('fechaSorteo').value = fecha.toISOString().slice(0, 16);
        document.getElementById('montoSorteo').value = data.monto;
        
        // Actualizar estado
        const fechaFormateada = fecha.toLocaleDateString('es-AR', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        document.getElementById('sorteoStatus').innerHTML = `
          📅 <strong>Fecha:</strong> ${fechaFormateada}<br>
          💰 <strong>Premio Total:</strong> $${data.monto.toLocaleString()} ARS<br>
          ⏰ <strong>Estado:</strong> ${fecha > new Date() ? '🟡 Programado' : '🔴 Finalizado'}
        `;
      } else {
        document.getElementById('sorteoStatus').textContent = 'No hay sorteo configurado';
      }
    } catch (error) {
      console.error('Error cargando configuración:', error);
      mostrarAlerta('Error al cargar configuración del sorteo', 'error');
    }
  }

  // Cargar participantes con join a profiles
  async function cargarParticipantes() {
    try {
      const { data, error } = await client
        .from('sorteo_participantes')
        .select(`
          *,
          profiles!inner(username, email)
        `)
        .order('created_at', { ascending: false });

      if (error) throw error;

      participantesList = data || [];
      
      const total = participantesList.length;
      const califican = participantesList.filter(p => p.califica).length;
      const noCalifican = total - califican;
      
      document.getElementById('totalParticipantes').textContent = total;
      document.getElementById('participantesCalifican').textContent = califican;
      document.getElementById('participantesNoCalifican').textContent = noCalifican;
      
      mostrarParticipantes();
    } catch (error) {
      console.error('Error cargando participantes:', error);
      mostrarAlerta('Error al cargar participantes', 'error');
    }
  }

  // Mostrar participantes en la lista
  function mostrarParticipantes() {
    const container = document.getElementById('participantsList');
    
    if (participantesList.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; color: #666; padding: 20px;">
          <i class="fas fa-users-slash"></i> No hay participantes registrados
        </div>
      `;
      return;
    }
    
    container.innerHTML = participantesList.map(p => `
      <div class="participant-item">
        <div>
          <div class="participant-email">${p.profiles.email}</div>
          <div style="font-size: 0.8rem; color: #ccc;">
            ${p.profiles.username || 'Sin nombre'} • ${new Date(p.created_at).toLocaleDateString('es-AR')}
          </div>
        </div>
        <div class="participant-status ${p.califica ? 'califica' : 'no-califica'}">
          ${p.califica ? '✅ Califica' : '❌ No califica'}
        </div>
      </div>
    `).join('');
  }

  // Cargar ganadores con join a profiles
  async function cargarGanadores() {
    try {
      const { data, error } = await client
        .from('sorteo_ganadores')
        .select(`
          *,
          profiles!inner(username, email)
        `)
        .order('posicion', { ascending: true });

      if (error) throw error;

      ganadoresActuales = data || [];
      mostrarGanadores();
    } catch (error) {
      console.error('Error cargando ganadores:', error);
    }
  }

  // Mostrar ganadores
  function mostrarGanadores() {
    const container = document.getElementById('winnersContainer');
    
    if (ganadoresActuales.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; color: #666; padding: 20px;">
          <i class="fas fa-trophy"></i> No hay ganadores seleccionados
        </div>
      `;
      return;
    }
    
    container.innerHTML = ganadoresActuales.map((g) => `
      <div class="winner-item">
        <div>
          <div class="winner-email">${g.profiles.email}</div>
          <div style="font-size: 0.8rem; color: #ccc;">
            ${g.profiles.username || 'Sin nombre'} • Premio agregado al saldo
          </div>
        </div>
        <div class="winner-prize">
          🏆 ${g.posicion}° Lugar - $${g.premio.toLocaleString()}
        </div>
      </div>
    `).join('');
  }

  // Guardar configuración
  document.getElementById('sorteoConfigForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const fecha = document.getElementById('fechaSorteo').value;
    const monto = parseInt(document.getElementById('montoSorteo').value);
    
    if (!fecha || !monto) {
      mostrarAlerta('Por favor completa todos los campos', 'error');
      return;
    }
    
    try {
      e.target.classList.add('loading');
      
      // Eliminar configuración anterior
      await client.from('sorteo_config').delete().neq('id', 0);
      
      // Insertar nueva configuración
      const { error } = await client
        .from('sorteo_config')
        .insert([{
          fecha: fecha,
          monto: monto
        }]);
      
      if (error) throw error;
      
      mostrarAlerta('✅ Configuración guardada exitosamente', 'success');
      await cargarConfiguracion();
      
    } catch (error) {
      console.error('Error guardando configuración:', error);
      mostrarAlerta('Error al guardar configuración: ' + error.message, 'error');
    } finally {
      e.target.classList.remove('loading');
    }
  });

// ✅ FUNCIÓN NUEVA: Sumar premio al saldo del usuario
  async function sumarPremioAlSaldo(usuarioId, premio) {
    try {
      console.log(`💰 Sumando ${premio} al saldo del usuario ${usuarioId}`);
      
      // Obtener saldo actual
      const { data: balance, error: balanceError } = await client
        .from('balances')
        .select('saldo')
        .eq('usuario_id', usuarioId)
        .maybeSingle();
      
      if (balanceError) throw balanceError;
      
      if (balance) {
        // Usuario ya tiene balance, actualizar
        const nuevoSaldo = balance.saldo + premio;
        
        const { error: updateError } = await client
          .from('balances')
          .update({ saldo: nuevoSaldo })
          .eq('usuario_id', usuarioId);
        
        if (updateError) throw updateError;
        
        console.log(`✅ Saldo actualizado: ${balance.saldo} + ${premio} = ${nuevoSaldo}`);
      } else {
        // Usuario no tiene balance, crear nuevo
        const { error: insertError } = await client
          .from('balances')
          .insert([{
            usuario_id: usuarioId,
            saldo: premio
          }]);
        
        if (insertError) throw insertError;
        
        console.log(`✅ Nuevo balance creado con ${premio}`);
      }
      
      return true;
    } catch (error) {
      console.error('Error sumando premio al saldo:', error);
      throw error;
    }
  }

  // ✅ FUNCIÓN NUEVA: Registrar premio en recompensas
  async function registrarPremioEnRecompensas(usuarioId, premio, posicion) {
    try {
      const { error } = await client
        .from('recompensas')
        .insert([{
          usuario_id: usuarioId,
          meta: null,
          fecha: new Date().toISOString(),
          monto: premio,
          moneda: 'ARS',
          aprobado: true,
          tipo: `sorteo_premio_${posicion}`
        }]);
      
      if (error) throw error;
      
      console.log(`📝 Premio registrado en recompensas: ${premio} ARS`);
      return true;
    } catch (error) {
      console.error('Error registrando premio en recompensas:', error);
      throw error;
    }
  }

  // ✅ FUNCIÓN ACTUALIZADA: Procesar ganadores con suma automática al saldo
  async function procesarGanadores() {
    const emailsText = document.getElementById('ganadoresEmails').value.trim();
    
    if (!emailsText) {
      mostrarAlerta('Por favor ingresa al menos un email', 'error');
      return;
    }
    
    if (!currentConfig) {
      mostrarAlerta('Primero configura el sorteo', 'error');
      return;
    }
    
    const emails = emailsText.split(',').map(e => e.trim().toLowerCase()).filter(e => e);
    
    if (emails.length === 0) {
      mostrarAlerta('No se encontraron emails válidos', 'error');
      return;
    }
    
    try {
      mostrarAlerta('🔄 Procesando ganadores...', 'warning');
      
      // Verificar que todos los emails existan y califiquen
      const { data: participantes, error: participantesError } = await client
        .from('sorteo_participantes')
        .select(`
          *,
          profiles!inner(email)
        `)
        .in('profiles.email', emails)
        .eq('califica', true);
      
      if (participantesError) throw participantesError;
      
      const emailsEncontrados = participantes.map(p => p.profiles.email.toLowerCase());
      const emailsNoEncontrados = emails.filter(e => !emailsEncontrados.includes(e));
      
      if (emailsNoEncontrados.length > 0) {
        mostrarAlerta(`Emails no encontrados o no califican: ${emailsNoEncontrados.join(', ')}`, 'error');
        return;
      }
      
      // Limpiar ganadores anteriores
      await client.from('sorteo_ganadores').delete().neq('id', 0);
      
      // Calcular premios (dividir el monto total entre los ganadores)
      const premioIndividual = Math.floor(currentConfig.monto / emails.length);
      
      // ✅ PROCESO COMPLETO: Insertar ganadores + Sumar al saldo + Registrar en recompensas
      for (let i = 0; i < participantes.length; i++) {
        const participante = participantes[i];
        const posicion = i + 1;
        
        console.log(`🏆 Procesando ganador ${posicion}: ${participante.profiles.email}`);
        
        // 1. Insertar en sorteo_ganadores
        const { error: insertError } = await client
          .from('sorteo_ganadores')
          .insert([{
            usuario_id: participante.usuario_id,
            sorteo_config_id: currentConfig.id,
            premio: premioIndividual,
            posicion: posicion
          }]);
        
        if (insertError) throw insertError;
        
        // 2. ✅ SUMAR PREMIO AL SALDO
        await sumarPremioAlSaldo(participante.usuario_id, premioIndividual);
        
        // 3. ✅ REGISTRAR EN RECOMPENSAS
        await registrarPremioEnRecompensas(participante.usuario_id, premioIndividual, posicion);
      }
      
      mostrarAlerta(`🎉 ¡${emails.length} ganador(es) procesado(s) exitosamente! 
        Premio individual: $${premioIndividual.toLocaleString()} 
        💰 Los premios se sumaron automáticamente a los saldos de los ganadores`, 'success');
      
      // Limpiar el textarea
      document.getElementById('ganadoresEmails').value = '';
      
      await cargarGanadores();
      
    } catch (error) {
      console.error('Error procesando ganadores:', error);
      mostrarAlerta('Error al procesar ganadores: ' + error.message, 'error');
    }
  }

  // Limpiar ganadores
  async function limpiarGanadores() {
    if (!confirm('⚠️ ¿Estás seguro de que quieres eliminar todos los ganadores?\n\nNOTA: Esto NO revertirá los premios ya sumados a los saldos.')) {
      return;
    }
    
    try {
      const { error } = await client
        .from('sorteo_ganadores')
        .delete()
        .neq('id', 0);
      
      if (error) throw error;
      
      mostrarAlerta('✅ Ganadores eliminados de la lista.\n💡 Los premios ya sumados a los saldos NO se revierten.', 'success');
      await cargarGanadores();
      
    } catch (error) {
      console.error('Error limpiando ganadores:', error);
      mostrarAlerta('Error al eliminar ganadores: ' + error.message, 'error');
    }
  }

  // ✅ FUNCIÓN ACTUALIZADA: Actualizar participación con lógica de saldo
  async function actualizarParticipacion() {
    if (!confirm('¿Estás seguro de que quieres recalcular la participación de todos los usuarios?\n\nCriterio: Usuarios con saldo > 0 califican para el sorteo.')) {
      return;
    }
    
    try {
      mostrarAlerta('🔄 Actualizando participación...', 'warning');
      
      // Obtener todos los usuarios
      const { data: usuarios, error: usuariosError } = await client
        .from('profiles')
        .select('id, email, username');
      
      if (usuariosError) throw usuariosError;
      
      let procesados = 0;
      let califican = 0;
      
      for (const usuario of usuarios) {
        // Verificar si ya existe en sorteo_participantes
        const { data: existeParticipante, error: existeError } = await client
          .from('sorteo_participantes')
          .select('id, califica')
          .eq('usuario_id', usuario.id)
          .maybeSingle();
        
        if (existeError) {
          console.error(`Error verificando usuario ${usuario.email}:`, existeError);
          continue;
        }
        
        // ✅ LÓGICA DE CALIFICACIÓN: Usuario con saldo > 0
        const calificaParaSorteo = await verificarCalificacionUsuario(usuario.id);
        
        if (existeParticipante) {
          // Actualizar participante existente solo si cambió
          if (existeParticipante.califica !== calificaParaSorteo) {
            const { error: updateError } = await client
              .from('sorteo_participantes')
              .update({ califica: calificaParaSorteo })
              .eq('usuario_id', usuario.id);
            
            if (updateError) {
              console.error(`Error actualizando usuario ${usuario.email}:`, updateError);
              continue;
            }
          }
        } else {
          // Crear nuevo participante
          const { error: insertError } = await client
            .from('sorteo_participantes')
            .insert([{
              usuario_id: usuario.id,
              califica: calificaParaSorteo
            }]);
          
          if (insertError) {
            console.error(`Error insertando usuario ${usuario.email}:`, insertError);
            continue;
          }
        }
        
        procesados++;
        if (calificaParaSorteo) califican++;
      }
      
      mostrarAlerta(`✅ Participación actualizada: ${procesados} usuarios procesados, ${califican} califican para el sorteo`, 'success');
      await cargarParticipantes();
      
    } catch (error) {
      console.error('Error actualizando participación:', error);
      mostrarAlerta('Error al actualizar participación: ' + error.message, 'error');
    }
  }

  // ✅ LÓGICA DE CALIFICACIÓN: Usuario califica si tiene saldo > 0
  async function verificarCalificacionUsuario(usuarioId) {
    try {
      const { data: balance, error } = await client
        .from('balances')
        .select('saldo')
        .eq('usuario_id', usuarioId)
        .maybeSingle();
      
      if (error) {
        console.error(`Error verificando saldo para usuario ${usuarioId}:`, error);
        return false;
      }
      
      // Califica si tiene saldo mayor a 0
      const tieneSaldo = balance && balance.saldo > 0;
      
      return tieneSaldo;
      
    } catch (error) {
      console.error(`Error en verificación de calificación para usuario ${usuarioId}:`, error);
      return false;
    }
  }

  // Mostrar alertas
  function mostrarAlerta(mensaje, tipo) {
    const alertsContainer = document.getElementById('alerts');
    const alertId = 'alert_' + Date.now();
    
    const alertClass = tipo === 'success' ? 'alert-success' : 
                     tipo === 'error' ? 'alert-error' : 
                     'alert-warning';
    
    const alertHTML = `
      <div id="${alertId}" class="alert ${alertClass}">
        <i class="fas ${tipo === 'success' ? 'fa-check-circle' : 
                       tipo === 'error' ? 'fa-exclamation-triangle' : 
                       'fa-info-circle'}"></i>
        ${mensaje}
      </div>
    `;
    
    alertsContainer.insertAdjacentHTML('beforeend', alertHTML);
    
    // Auto-remover después de 8 segundos para mensajes largos
    setTimeout(() => {
      const alertElement = document.getElementById(alertId);
      if (alertElement) {
        alertElement.style.opacity = '0';
        alertElement.style.transform = 'translateY(-20px)';
        setTimeout(() => alertElement.remove(), 300);
      }
    }, 8000);
  }

  // ✅ FUNCIÓN NUEVA: Exportar datos completos
  async function exportarDatos() {
    try {
      const data = {
        configuracion: currentConfig,
        participantes: participantesList,
        ganadores: ganadoresActuales,
        estadisticas: {
          total_participantes: participantesList.length,
          califican: participantesList.filter(p => p.califica).length,
          total_ganadores: ganadoresActuales.length,
          premio_total: currentConfig?.monto || 0,
          premio_individual: currentConfig && ganadoresActuales.length > 0 ? 
            Math.floor(currentConfig.monto / ganadoresActuales.length) : 0,
          fecha_exportacion: new Date().toISOString()
        }
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `sorteo_export_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      mostrarAlerta('✅ Datos exportados exitosamente', 'success');
      
    } catch (error) {
      console.error('Error exportando datos:', error);
      mostrarAlerta('Error al exportar datos: ' + error.message, 'error');
    }
  }

  // Inicializar cuando cargue la página
  document.addEventListener('DOMContentLoaded', init);

  // Agregar botón de exportar al final
  document.addEventListener('DOMContentLoaded', () => {
    // Crear botón de exportar
    const exportButton = document.createElement('button');
    exportButton.innerHTML = '<i class="fas fa-download"></i> Exportar Datos';
    exportButton.className = 'btn btn-warning';
    exportButton.style.width = '100%';
    exportButton.style.marginTop = '20px';
    exportButton.onclick = exportarDatos;
    
    // Agregar al final del segundo panel
    const secondPanel = document.querySelectorAll('.admin-panel')[1];
    if (secondPanel) {
      secondPanel.appendChild(exportButton);
    }
  });

  console.log('🎮 Panel Admin de Sorteos INTEGRADO cargado');
  console.log('🔗 Conectado con sistema completo:');
  console.log('  ✅ sorteo_config, sorteo_participantes, sorteo_ganadores');
  console.log('  ✅ balances (suma automática de premios)');
  console.log('  ✅ recompensas (registro de premios)');
  console.log('  ✅ profiles (datos de usuarios)');
  console.log('  💰 Los premios se suman automáticamente al saldo del ganador');
  console.log('  📊 Integración completa con panel de usuario');
</script>

</body>
</html>
